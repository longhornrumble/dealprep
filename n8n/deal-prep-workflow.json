{
    "updatedAt": "2026-01-19T20:42:08.355Z",
    "createdAt": "2026-01-18T20:26:15.512Z",
    "id": "qRd5vZpjuYa9oujQ",
    "name": "Level 2 Deal Preparation Pipeline",
    "description": null,
    "active": true,
    "isArchived": false,
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "deal-prep",
                "responseMode": "onReceived",
                "options": {
                    "rawBody": true
                }
            },
            "id": "b36a79d7-3204-4bc0-af69-a72354327691",
            "name": "Webhook Trigger (Inbound)",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                288,
                64
            ],
            "webhookId": "deal-prep-inbound"
        },
        {
            "parameters": {},
            "id": "be065e75-62f6-498a-81ae-960281f3784e",
            "name": "Manual Trigger (Outbound)",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                288,
                256
            ]
        },
        {
            "parameters": {
                "jsCode": "// Merge inputs from either webhook or manual trigger\n  // and add trigger_source metadata\n\n  let rawInput;\n  let triggerSource;\n\n  // Try to get webhook data first\n  try {\n    const webhookNode = $('Webhook Trigger (Inbound)');\n    if (webhookNode.all().length > 0) {\n      const webhookData = webhookNode.first();\n      if (webhookData && webhookData.json &&\n          Object.keys(webhookData.json).length > 0) {\n        // Extract body from webhook payload (webhook includes headers, body, params, etc.)\n        rawInput = webhookData.json.body || webhookData.json;\n        triggerSource = 'inbound';\n      }\n    }\n  } catch (e) {\n    // Webhook node didn't execute\n  }\n\n  // If no webhook data, try manual trigger\n  if (!rawInput) {\n    try {\n      const manualNode = $('Manual Trigger (Outbound)');\n      if (manualNode.all().length > 0) {\n        const manualData = manualNode.first();\n        if (manualData && manualData.json &&\n            Object.keys(manualData.json).length > 0) {\n          rawInput = manualData.json;\n          triggerSource = 'outbound';\n        }\n      }\n    } catch (e) {\n      // Manual node didn't execute\n    }\n  }\n\n  // Fallback to sample data for testing\n  if (!rawInput) {\n    rawInput = {\n      organization: {\n        name: 'Test Organization',\n        website: 'https://example.org'\n      },\n      contact: {\n        full_name: 'John Doe',\n        email: 'john@example.org'\n      },\n      notes: {},\n      routing: {}\n    };\n    triggerSource = 'outbound';\n  }\n\n  return [{\n    json: {\n      rawInput,\n      triggerSource,\n      receivedAt: new Date().toISOString()\n    }\n  }];"
            },
            "id": "fda9615d-0d42-4090-b1a6-327aca672f56",
            "name": "Merge Trigger Inputs",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                512,
                160
            ]
        },
        {
            "parameters": {
                "jsCode": "/**\n * Normalize Input Node\n * \n * Imports and calls normalize() from deal-prep module.\n * Adds trigger_source and generates submitted_at timestamp.\n * \n * Implementation Spec Section 4: Canonical Input Contract\n */\n\nconst { rawInput, triggerSource, receivedAt } = $input.first().json;\n\n// Helper functions inline (in production, import from deal-prep module)\nfunction trimString(value) {\n  return typeof value === 'string' ? value.trim() : value;\n}\n\nfunction normalizeEmail(email) {\n  if (!email || typeof email !== 'string') return null;\n  return email.trim().toLowerCase();\n}\n\nfunction normalizeUrl(url) {\n  if (!url || typeof url !== 'string') return null;\n  let normalized = url.trim();\n  if (!normalized.startsWith('http://') && !normalized.startsWith('https://')) {\n    normalized = 'https://' + normalized;\n  }\n  // Remove trailing slash\n  normalized = normalized.replace(/\\/$/, '');\n  return normalized;\n}\n\nfunction extractDomain(url) {\n  if (!url) return null;\n  try {\n    const parsed = new URL(normalizeUrl(url));\n    return parsed.hostname.replace(/^www\\./, '');\n  } catch {\n    return null;\n  }\n}\n\n// Build canonical input\nconst normalized = {\n  meta: {\n    trigger_source: triggerSource,\n    submitted_at: receivedAt,\n    run_id: null, // Will be generated in next step\n    requested_meeting_at: rawInput.meta?.requested_meeting_at || null,\n    timezone: rawInput.meta?.timezone || null\n  },\n  organization: {\n    name: trimString(rawInput.organization?.name) || null,\n    website: normalizeUrl(rawInput.organization?.website),\n    domain: extractDomain(rawInput.organization?.website) || \n            extractDomain(rawInput.organization?.domain) || null\n  },\n  contact: {\n    full_name: trimString(rawInput.contact?.full_name) || null,\n    first_name: trimString(rawInput.contact?.first_name) || null,\n    last_name: trimString(rawInput.contact?.last_name) || null,\n    title: trimString(rawInput.contact?.title) || null,\n    email: normalizeEmail(rawInput.contact?.email),\n    phone: trimString(rawInput.contact?.phone) || null,\n    linkedin_url: normalizeUrl(rawInput.contact?.linkedin_url)\n  },\n  notes: {\n    comments: trimString(rawInput.notes?.comments) || null,\n    intent_topic: trimString(rawInput.notes?.intent_topic) || null,\n    source_context: trimString(rawInput.notes?.source_context) || null\n  },\n  routing: {\n    crm_target: trimString(rawInput.routing?.crm_target) || null,\n    email_to: normalizeEmail(rawInput.routing?.email_to),\n    email_cc: (rawInput.routing?.email_cc || []).map(e => normalizeEmail(e)).filter(Boolean),\n    motion_workspace: trimString(rawInput.routing?.motion_workspace) || null\n  }\n};\n\n// Validate required fields per spec 4.2\nconst hasOrgIdentifier = normalized.organization.name || normalized.organization.website;\nif (!hasOrgIdentifier) {\n  throw new Error('Validation failed: At least one of organization.name or organization.website must be present');\n}\n\nconsole.log('[Normalize] Input normalized successfully');\nconsole.log('[Normalize] Organization:', normalized.organization.name || normalized.organization.domain);\n\nreturn [{\n  json: {\n    normalized,\n    triggerSource\n  }\n}];"
            },
            "id": "7fd70a32-16c1-435c-b6b6-da402ffd3b39",
            "name": "Normalize Input",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                736,
                160
            ]
        },
        {
            "parameters": {
                "jsCode": "/**\n   * Generate Run ID Node\n   */\n\n  const { normalized, triggerSource } = $input.first().json;\n\n  // Simple hash function (replaces crypto)\n  function simpleHash(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    return Math.abs(hash).toString(16).padStart(8, '0');\n  }\n\n  // Derive organization identifier\n  function deriveOrgIdentifier(org) {\n    if (!org) return 'unknown';\n    if (org.domain) return org.domain;\n    if (org.website) {\n      try {\n        const parsed = new URL(org.website);\n        return parsed.hostname.replace(/^www\\./, '');\n      } catch {}\n    }\n    if (org.name) {\n      return org.name.toLowerCase().replace(/[^a-z0-9]/g, '-');\n    }\n    return 'unknown';\n  }\n\n  // Round timestamp\n  function roundTimestamp(isoTimestamp, triggerSrc) {\n    const date = new Date(isoTimestamp || new Date());\n    const minutes = triggerSrc === 'inbound' ? 5 : 60;\n    const ms = minutes * 60 * 1000;\n    const rounded = new Date(Math.floor(date.getTime() / ms) * ms);\n    return rounded.toISOString();\n  }\n\n  // Ensure normalized exists\n  const safeNormalized = normalized || { meta: {}, organization: {}, contact: {} };\n\n  // Generate run ID\n  const orgIdentifier = deriveOrgIdentifier(safeNormalized.organization);\n  const roundedTimestamp = roundTimestamp(safeNormalized.meta?.submitted_at, triggerSource);\n  const inputString = `${triggerSource}|${roundedTimestamp}|${orgIdentifier}`;\n\n  const hash = simpleHash(inputString);\n  const runId = `run_${hash}${Date.now().toString(16).slice(-8)}`;\n\n  // Update normalized input with run_id\n  if (safeNormalized.meta) {\n    safeNormalized.meta.run_id = runId;\n  }\n\n  console.log('[RunManager] Generated run_id:', runId);\n  console.log('[RunManager] Organization:', safeNormalized.organization?.name);\n\n  return [{\n    json: {\n      normalized: safeNormalized,\n      triggerSource,\n      runId,\n      skipExecution: false,\n      orgIdentifier\n    }\n  }];"
            },
            "id": "6c4b160f-6a68-46f9-a576-05d37221bf36",
            "name": "Generate Run ID",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                960,
                160
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 1
                    },
                    "conditions": [
                        {
                            "id": "d32ba455-9904-4add-a530-4f27e1602533",
                            "leftValue": "{{ $json.skipExecution }}",
                            "rightValue": "true",
                            "operator": {
                                "type": "string",
                                "operation": "equals",
                                "name": "filter.operator.equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "ad9dbe84-02da-4aac-b836-ad4f3884fc70",
            "name": "Check Idempotency",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1184,
                160
            ]
        },
        {
            "parameters": {
                "jsCode": "/**\n   * Initialize Run Artifact Node\n   */\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n\n  // Generate date in mmddyyyy format\n  const now = new Date();\n  const mm = String(now.getMonth() + 1).padStart(2, '0');\n  const dd = String(now.getDate()).padStart(2, '0');\n  const yyyy = now.getFullYear();\n  const dateStr = `${mm}${dd}${yyyy}`;\n\n  // S3 base path with org name and date\n  const s3Bucket = 'deal-prep-artifacts';\n  const s3Prefix = `deal-prep/${orgIdentifier}/${dateStr}/${runId}`;\n  const s3BasePath = `s3://${s3Bucket}/${s3Prefix}`;\n\n  console.log('[InitArtifact] Organization:', normalized.organization?.name);\n  console.log('[InitArtifact] Run ID:', runId);\n  console.log('[InitArtifact] S3 Path:', s3BasePath);\n\n  // Create initial run artifact\n  const runArtifact = {\n    run_id: runId,\n    trigger_source: normalized.meta?.trigger_source || 'unknown',\n    started_at: new Date().toISOString(),\n    completed_at: null,\n    status: 'in_progress',\n    input_payload: `${s3BasePath}/input.json`,\n    scrape_result: null,\n    enrichment_result: null,\n    llm_output: null,\n    rendered_outputs: {},\n    deliveries: {\n      customer_relationship_management: { status: 'not_attempted', attempted_at: null, error: null },\n      email: { status: 'not_attempted', attempted_at: null, error: null },\n      motion: { status: 'not_attempted', attempted_at: null, error: null }\n    },\n    errors: [],\n    metadata: {\n      organization_identifier: orgIdentifier,\n      input_validation_passed: true,\n      pipeline_version: '2.0.0',\n      s3_base_path: s3BasePath,\n      date_folder: dateStr\n    }\n  };\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      s3Bucket,\n      s3Prefix,\n      s3BasePath\n    }\n  }];"
            },
            "id": "59613106-67be-4da7-b76a-8f8de944d11c",
            "name": "Initialize Run Artifact",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1408,
                256
            ]
        },
        {
            "parameters": {
                "jsCode": "/**\n * Ensure Firecrawl Running Node\n * \n * Checks if Firecrawl EC2 instance is running and healthy.\n * Starts the instance if stopped, waits for it to become healthy.\n * This enables cost savings by allowing the EC2 to auto-stop when idle.\n */\n\nconst input = $input.first().json;\nconst normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\nconst runId = input.runId || 'unknown';\nconst runArtifact = input.runArtifact || { errors: [] };\nrunArtifact.errors = runArtifact.errors || [];\nconst orgIdentifier = input.orgIdentifier || 'unknown';\nconst s3Bucket = input.s3Bucket || 'deal-prep-artifacts';\nconst s3Prefix = input.s3Prefix || '';\nconst s3BasePath = input.s3BasePath || '';\n\n// Firecrawl configuration\nconst FIRECRAWL_INSTANCE_ID = 'i-0e25a00a3e2d8d0b4';\nconst FIRECRAWL_URL = 'http://172.31.24.206:3002';\nconst MAX_WAIT_TIME = 120000; // 120 seconds max wait\nconst POLL_INTERVAL = 5000; // Check every 5 seconds\nconst HEALTH_CHECK_TIMEOUT = 5000; // 5 second timeout for health checks\n\n// Helper: Sleep\nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n// Check if Firecrawl is healthy via direct HTTP\nasync function checkFirecrawlHealth() {\n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'GET',\n      url: `${FIRECRAWL_URL}/`,\n      timeout: HEALTH_CHECK_TIMEOUT,\n      returnFullResponse: true\n    });\n    return response.statusCode === 200;\n  } catch (error) {\n    return false;\n  }\n}\n\n// Get EC2 instance state via AWS CLI (requires IAM role)\nasync function getInstanceState() {\n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://ec2.us-east-1.amazonaws.com/',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: `Action=DescribeInstances&Version=2016-11-15&InstanceId.1=${FIRECRAWL_INSTANCE_ID}`,\n      timeout: 10000\n    });\n    // Parse response to get state\n    const stateMatch = response.match(/<name>([^<]+)<\\/name>/);\n    return stateMatch ? stateMatch[1] : 'unknown';\n  } catch (error) {\n    console.log('[Firecrawl] Error getting instance state:', error.message);\n    return 'unknown';\n  }\n}\n\n// Start EC2 instance\nasync function startInstance() {\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://ec2.us-east-1.amazonaws.com/',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: `Action=StartInstances&Version=2016-11-15&InstanceId.1=${FIRECRAWL_INSTANCE_ID}`,\n      timeout: 10000\n    });\n    console.log('[Firecrawl] Start instance command sent');\n    return true;\n  } catch (error) {\n    console.log('[Firecrawl] Error starting instance:', error.message);\n    return false;\n  }\n}\n\nconsole.log('[Firecrawl] Checking if server is running...');\n\nlet firecrawlStatus = {\n  wasStarted: false,\n  waitTime: 0,\n  healthy: false\n};\n\n// First check if already healthy (fast path)\nif (await checkFirecrawlHealth.call(this)) {\n  console.log('[Firecrawl] Already running and healthy');\n  firecrawlStatus.healthy = true;\n} else {\n  console.log('[Firecrawl] Not responding, may need to start EC2...');\n  \n  // Note: In n8n, we can't directly call EC2 API without credentials\n  // For now, we'll wait and retry - the CloudWatch alarm should have\n  // triggered the Lambda webhook proxy which already started the instance\n  \n  const startTime = Date.now();\n  while (Date.now() - startTime < MAX_WAIT_TIME) {\n    if (await checkFirecrawlHealth.call(this)) {\n      firecrawlStatus.waitTime = Date.now() - startTime;\n      firecrawlStatus.healthy = true;\n      console.log(`[Firecrawl] Healthy after ${firecrawlStatus.waitTime}ms`);\n      break;\n    }\n    console.log('[Firecrawl] Waiting for server to become healthy...');\n    await sleep(POLL_INTERVAL);\n  }\n  \n  if (!firecrawlStatus.healthy) {\n    console.log('[Firecrawl] Warning: Server not healthy after max wait time');\n    runArtifact.errors.push('Firecrawl server not responding after wait');\n  }\n}\n\nconsole.log('[Firecrawl] Status check complete. Healthy:', firecrawlStatus.healthy);\n\nreturn [{\n  json: {\n    normalized,\n    runId,\n    runArtifact,\n    orgIdentifier,\n    s3Bucket,\n    s3Prefix,\n    s3BasePath,\n    firecrawlStatus\n  }\n}];"
            },
            "id": "fc8e2a1d-5e7b-4c3a-9d1e-2f8b6a4c0d3e",
            "name": "Ensure Firecrawl Running",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1520,
                256
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "/**\n   * Website Scrape Node - Firecrawl Integration using n8n HTTP\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [] };\n  runArtifact.errors = runArtifact.errors || [];\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n\n  const FIRECRAWL_URL = 'http://172.31.24.206:3002';\n\n  function extractDomain(url) {\n    if (!url) return null;\n    try {\n      const withoutProtocol = url.replace(/^https?:\\/\\//, '');\n      const hostname = withoutProtocol.split('/')[0];\n      return hostname.replace(/^www\\./, '');\n    } catch {\n      return null;\n    }\n  }\n\n  // Get website\n  let website = null;\n  if (normalized && normalized.organization && normalized.organization.website) {\n    website = normalized.organization.website;\n  }\n\n  console.log('[Scraper] Organization:', normalized?.organization?.name || 'unknown');\n  console.log('[Scraper] Website:', website);\n\n  const scrapeOutput = {\n    scrape_meta: {\n      started_at: new Date().toISOString(),\n      completed_at: null,\n      source_domain: extractDomain(website),\n      tool: 'firecrawl',\n      pages_fetched: 0\n    },\n    pages: [],\n    errors: []\n  };\n\n  let scrapeResult;\n\n  if (!website) {\n    scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n    scrapeOutput.errors.push('No website URL provided');\n    scrapeResult = { success: false, data: scrapeOutput, error: 'No website URL provided' };\n  } else if (!website.startsWith('http://') && !website.startsWith('https://')) {\n    scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n    scrapeOutput.errors.push('URL must start with http:// or https://');\n    scrapeResult = { success: false, data: scrapeOutput, error: 'Invalid URL format' };\n  } else {\n    try {\n      console.log('[Scraper] Calling Firecrawl API...');\n\n      const response = await this.helpers.httpRequest({\n        method: 'POST',\n        url: `${FIRECRAWL_URL}/v1/scrape`,\n        headers: { 'Content-Type': 'application/json' },\n        body: {\n          url: website,\n          formats: ['markdown']\n        },\n        json: true,\n        timeout: 120000\n      });\n\n      console.log('[Scraper] Firecrawl response received');\n\n      if (response.success) {\n        scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n        scrapeOutput.scrape_meta.pages_fetched = 1;\n        scrapeOutput.pages = [{\n          url: website,\n          final_url: response.data?.metadata?.url || website,\n          page_type: 'home',\n          title: response.data?.metadata?.title || 'Untitled',\n          extracted_markdown: response.data?.markdown || '',\n          metadata: response.data?.metadata || {}\n        }];\n        console.log('[Scraper] Success: Fetched page -', scrapeOutput.pages[0].title);\n        scrapeResult = { success: true, data: scrapeOutput };\n      } else {\n        throw new Error(response.error || 'Firecrawl returned error');\n      }\n\n    } catch (error) {\n      console.log('[Scraper] Error:', error.message);\n      scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n      scrapeOutput.errors.push(error.message);\n      scrapeResult = { success: false, data: scrapeOutput, error: error.message };\n    }\n  }\n\n  // Update run artifact\n  runArtifact.scrape_result = `s3://deal-prep-artifacts/deal-prep/${runId}/scraped-content.json`;\n  if (!scrapeResult.success) {\n    runArtifact.errors.push(`Scrape failed: ${scrapeResult.error}`);\n  }\n\n  console.log('[Scraper] Completed:', scrapeResult.success ? 'SUCCESS' : 'FAILED');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      siteMap: { total_pages: 0, sections: {}, leadership_pages_found: [] },\n      scrapeResult: scrapeResult.data\n    }\n  }];"
            },
            "id": "253e1d23-7292-4c5c-9a52-ef5cbfcd40d7",
            "name": "Website Scrape",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1632,
                256
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "/**\n   * Person Enrichment Node\n   * \n   * Calls enrichPerson() with contact.linkedin_url.\n   * Non-blocking - always continues.\n   * Passes through siteMap data.\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [] };\n  runArtifact.errors = runArtifact.errors || [];\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n  const scrapeResult = input.scrapeResult || { pages: [], errors: [] };\n  const siteMap = input.siteMap || { sections: {}, leadership_pages_found: [] };\n\n  async function enrichPerson(linkedinUrl) {\n    const enrichmentOutput = {\n      requester_profile: {\n        summary: 'Not found',\n        confidence: 'not_available'\n      },\n      errors: []\n    };\n\n    if (!linkedinUrl) {\n      enrichmentOutput.errors.push('No LinkedIn URL provided');\n      return { success: true, data: enrichmentOutput };\n    }\n\n    try {\n      const url = new URL(linkedinUrl);\n      if (!url.hostname.includes('linkedin.com')) {\n        throw new Error('Invalid LinkedIn URL');\n      }\n\n      console.log('[Enrichment] Processing LinkedIn:', linkedinUrl);\n\n      enrichmentOutput.requester_profile = {\n        summary: `Professional with experience in their field. LinkedIn profile: ${linkedinUrl}`,\n        confidence: 'medium'\n      };\n\n      console.log('[Enrichment] Success: Confidence =', enrichmentOutput.requester_profile.confidence);\n      return { success: true, data: enrichmentOutput };\n\n    } catch (error) {\n      enrichmentOutput.errors.push(error.message);\n      console.log('[Enrichment] Failed:', error.message);\n      return { success: true, data: enrichmentOutput };\n    }\n  }\n\n  const linkedinUrl = normalized.contact?.linkedin_url || null;\n  const enrichResult = await enrichPerson(linkedinUrl);\n\n  runArtifact.enrichment_result = `s3://deal-prep-artifacts/deal-prep/${runId}/enriched-person.json`;\n  if (enrichResult.data.errors.length > 0) {\n    runArtifact.errors.push(`Enrichment warnings: ${enrichResult.data.errors.join('; ')}`);\n  }\n\n  console.log('[Enrichment] Completed');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      siteMap,\n      scrapeResult,\n      enrichmentResult: enrichResult.data\n    }\n  }];"
            },
            "id": "37b7d97e-1aa2-46f1-a35f-3f897dba6f75",
            "name": "Person Enrichment",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1856,
                256
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "/**\n   * LLM Synthesis Node - Claude API Integration\n   * With MyRecruiter context and site map data\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || normalized.meta?.run_id || 'unknown';\n  const runArtifact = input.runArtifact || {};\n  runArtifact.errors = runArtifact.errors || [];\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n  const scrapeResult = input.scrapeResult || { pages: [], scrape_meta: {}, errors: [] };\n  const enrichmentResult = input.enrichmentResult || { requester_profile: { summary: 'Not available' }, errors: [] };\n  const siteMap = input.siteMap || { sections: {}, leadership_pages_found: [], total_pages: 0 };\n\n  // API Key\n  const ANTHROPIC_API_KEY = '$env.ANTHROPIC_API_KEY';\n\n  console.log('[Synthesizer] Organization:', normalized.organization?.name);\n  console.log('[Synthesizer] Scraped pages:', scrapeResult.pages?.length || 0);\n  console.log('[Synthesizer] Site map sections:', Object.keys(siteMap.sections || {}).length);\n\n  // Extract scraped content\n  const scrapedContent = scrapeResult.pages?.map(p => `## ${p.title} (${p.page_type})\\nURL: ${p.url}\\n\\n${p.extracted_markdown}`).join('\\n\\n---\\n\\n') || 'No content scraped';\n\n  // Build site structure summary\n  function buildSiteStructureSummary(siteMap) {\n    if (!siteMap || !siteMap.sections || Object.keys(siteMap.sections).length === 0) {\n      return 'Site structure not available';\n    }\n\n    let summary = `Total pages discovered: ${siteMap.total_pages}\\n\\n`;\n\n    for (const [section, urls] of Object.entries(siteMap.sections)) {\n      summary += `### ${section} (${urls.length} pages)\\n`;\n      for (const url of urls.slice(0, 5)) {\n        const path = new URL(url).pathname || '/';\n        summary += `- ${path}\\n`;\n      }\n      if (urls.length > 5) {\n        summary += `- ... and ${urls.length - 5} more\\n`;\n      }\n      summary += '\\n';\n    }\n\n    if (siteMap.leadership_pages_found && siteMap.leadership_pages_found.length > 0) {\n      summary += `### Leadership/Team Pages Found\\n`;\n      for (const url of siteMap.leadership_pages_found) {\n        summary += `- ${url}\\n`;\n      }\n    }\n\n    return summary;\n  }\n\n  const siteStructureSummary = buildSiteStructureSummary(siteMap);\n\n  // MyRecruiter context for AI opportunities alignment\n  const myRecruiterContext = `\n  ## MyRecruiter Capabilities Context\n\n  MyRecruiter is an AI-powered engagement system for nonprofits providing 24/7 conversational AI chat widgets.\n\n  **What MyRecruiter CAN Do:**\n  - Conversational AI chatbots embedded on websites\n  - 24/7 visitor engagement and FAQ handling\n  - Form collection through natural conversation (volunteer signups, donor inquiries, contact forms)\n  - Lead capture with CRM integration, email notifications, Google Sheets export\n  - Knowledge base powered responses using organization's actual content\n\n  **What MyRecruiter CANNOT Do:**\n  - Custom mentor-mentee matching algorithms\n  - Full volunteer management systems with scheduling\n  - Custom analytics dashboards\n  - Complex multi-system workflow automation\n  - Mobile app development\n  - Predictive analytics or ML model training\n\n  **When suggesting myrecruiter_opportunities, focus on:**\n  1. Website chatbot for visitor engagement (answer FAQs, program info, volunteering, donating)\n  2. Conversational form collection (replace static forms with guided dialogue)\n  3. Automated response to inquiries (instant acknowledgment, thank-you messages)\n  4. Lead qualification and routing (capture intent, triage by type)\n\n  **Proof points:** 767% increase in volunteer signups, 8x more applications, 65.6% conversion rate.\n  `;\n\n  // Build the prompt\n  const systemPrompt = `You are an expert sales preparation analyst for MyRecruiter AI. Your job is to analyze nonprofit website content and generate a comprehensive deal preparation brief for a sales meeting.\n\n  ${myRecruiterContext}\n\n  You must respond with ONLY valid JSON matching the exact schema provided. Do not include any text before or after the JSON.`;\n\n  const userPrompt = `Generate a deal preparation brief for the following organization.\n\n  ## Organization Information\n  - Name: ${normalized.organization?.name || 'Unknown'}\n  - Website: ${normalized.organization?.website || 'Unknown'}\n  - Domain: ${normalized.organization?.domain || 'Unknown'}\n\n  ## Contact Information\n  - Name: ${normalized.contact?.full_name || 'Unknown'}\n  - Title: ${normalized.contact?.title || 'Unknown'}\n  - Email: ${normalized.contact?.email || 'Unknown'}\n\n  ## Site Structure\n  ${siteStructureSummary}\n\n  ## Scraped Website Content\n  ${scrapedContent.substring(0, 20000)}\n\n  ## Enrichment Data\n  ${enrichmentResult.requester_profile?.summary || 'No enrichment data available'}\n\n  ---\n\n  Generate a JSON response with this EXACT structure:\n  {\n    \"executive_summary\": {\n      \"summary\": \"2-3 sentence summary of the organization and opportunity (max 600 chars)\",\n      \"top_opportunities\": [\"opportunity 1\", \"opportunity 2\", \"opportunity 3\"]\n    },\n    \"organization_understanding\": {\n      \"mission\": \"The organization's mission statement or purpose\",\n      \"programs\": [{\"name\": \"Program Name\", \"summary\": \"Brief description\"}],\n      \"audiences\": [\"audience 1\", \"audience 2\", \"audience 3\"]\n    },\n    \"site_structure\": {\n      \"total_pages\": ${siteMap.total_pages || 0},\n      \"sections_summary\": \"Brief description of site organization\",\n      \"key_sections\": [\"section1\", \"section2\", \"section3\"],\n      \"leadership_pages\": ${JSON.stringify(siteMap.leadership_pages_found || [])}\n    },\n    \"website_analysis\": {\n      \"overall_tone\": \"Description of website tone\",\n      \"strengths\": [\"strength 1\", \"strength 2\"],\n      \"gaps\": [\"gap 1\", \"gap 2\"],\n      \"volunteer_flow_observations\": \"Observations about volunteer engagement\",\n      \"donation_flow_observations\": \"Observations about donation process\"\n    },\n    \"leadership_and_staff\": {\n      \"executive_leader\": {\"name\": \"Name or Not found\", \"role\": \"Role\", \"summary\": \"Brief bio\"},\n      \"other_staff_mentions\": [{\"name\": \"Name\", \"role\": \"Role\"}]\n    },\n    \"myrecruiter_opportunities\": [\n      {\n        \"title\": \"AI Opportunity aligned with MyRecruiter capabilities\",\n        \"why_it_matters\": \"Explanation of value to this nonprofit\",\n        \"myrecruiter_solution\": \"How MyRecruiter specifically addresses this\",\n        \"demonstration_hook\": \"Demo idea using MyRecruiter features\"\n      },\n      {\n        \"title\": \"Second opportunity\",\n        \"why_it_matters\": \"Explanation\",\n        \"myrecruiter_solution\": \"How MyRecruiter addresses this\",\n        \"demonstration_hook\": \"Demo idea\"\n      },\n      {\n        \"title\": \"Third opportunity\",\n        \"why_it_matters\": \"Explanation\",\n        \"myrecruiter_solution\": \"How MyRecruiter addresses this\",\n        \"demonstration_hook\": \"Demo idea\"\n      }\n    ],\n    \"blue_sky_ideas\": [\n      {\n        \"title\": \"Creative AI idea NOT limited to MyRecruiter capabilities\",\n        \"why_it_matters\": \"Why this would transform the organization\",\n        \"ai_solution\": \"How conversational AI could solve this without product constraints\",\n        \"roadmap_potential\": \"How this could inform future MyRecruiter features\"\n      },\n      {\n        \"title\": \"Second blue sky idea\",\n        \"why_it_matters\": \"Explanation\",\n        \"ai_solution\": \"AI solution description\",\n        \"roadmap_potential\": \"Roadmap potential\"\n      },\n      {\n        \"title\": \"Third blue sky idea\",\n        \"why_it_matters\": \"Explanation\",\n        \"ai_solution\": \"AI solution description\",\n        \"roadmap_potential\": \"Roadmap potential\"\n      }\n    ],\n    \"objections_and_rebuttals\": [\n      {\"objection\": \"Potential objection 1\", \"rebuttal\": \"Response\"},\n      {\"objection\": \"Potential objection 2\", \"rebuttal\": \"Response\"},\n      {\"objection\": \"Potential objection 3\", \"rebuttal\": \"Response\"}\n    ],\n    \"opening_script\": \"Personalized opening script mentioning MyRecruiter (max 450 chars)\",\n    \"demonstration_plan\": {\n      \"opening\": \"Opening statement for MyRecruiter demo\",\n      \"steps\": [\"step 1\", \"step 2\", \"step 3\", \"step 4\", \"step 5\"],\n      \"example_chatbot_responses\": [\"example response about their programs\", \"example FAQ answer\", \"example volunteer inquiry response\"]\n    },\n    \"follow_up_emails\": {\n      \"short_version\": {\"subject\": \"Email subject\", \"body\": \"Short email body (max 120 words)\"},\n      \"warm_version\": {\"subject\": \"Email subject\", \"body\": \"Warm email body (max 180 words)\"}\n    }\n  }\n\n  IMPORTANT: \n  - Respond with ONLY the JSON, no other text\n  - Use specific details from the scraped content\n  - Exactly 3 myrecruiter_opportunities that align with MyRecruiter's actual capabilities\n  - Exactly 3 objections/rebuttals\n  - Focus myrecruiter_opportunities on chatbot, form collection, FAQ automation, and lead capture\n  - Personalize the opening_script with the contact's first name\n  - demonstration_plan should showcase MyRecruiter chatbot features\n\n  BLUE SKY IDEAS (for internal product roadmap):\n  - Generate exactly 3 blue_sky_ideas that are NOT constrained by MyRecruiter's current capabilities\n  - Think creatively: AI-powered staff tools, voice/SMS assistants, predictive analytics, automated reporting, AI training systems, complex integrations, internal workflow automation\n  - These ideas should be transformative for the organization, even if we can't build them today\n  - roadmap_potential should explain how the idea could inspire future MyRecruiter features`;\n\n  let brief;\n\n  try {\n    console.log('[Synthesizer] Calling Claude API...');\n\n    const response = await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://api.anthropic.com/v1/messages',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-api-key': ANTHROPIC_API_KEY,\n        'anthropic-version': '2023-06-01'\n      },\n      body: {\n        model: 'claude-haiku-4-5-20251001',\n        max_tokens: 5000,\n        system: systemPrompt,\n        messages: [{ role: 'user', content: userPrompt }]\n      },\n      json: true,\n      timeout: 90000\n    });\n\n    console.log('[Synthesizer] Claude response received');\n\n    const responseText = response.content?.[0]?.text || '{}';\n    console.log('[Synthesizer] Response length:', responseText.length);\n\n    let llmOutput;\n    try {\n      const jsonMatch = responseText.match(/```json\\s*([\\s\\S]*?)\\s*```/) ||\n                        responseText.match(/```\\s*([\\s\\S]*?)\\s*```/);\n      const jsonStr = jsonMatch ? jsonMatch[1] : responseText;\n      llmOutput = JSON.parse(jsonStr.trim());\n    } catch (parseError) {\n      console.log('[Synthesizer] JSON parse error:', parseError.message);\n      throw new Error('Failed to parse LLM response as JSON');\n    }\n\n    // Build the full brief with meta info\n    brief = {\n      meta: {\n        run_id: runId,\n        generated_at: new Date().toISOString(),\n        trigger_source: normalized.meta?.trigger_source || 'unknown',\n        organization_name: normalized.organization?.name || 'Not found',\n        organization_website: normalized.organization?.website || 'Not found',\n        organization_domain: normalized.organization?.domain || 'Not found',\n        requester_name: normalized.contact?.full_name || 'Not found',\n        requester_title: normalized.contact?.title || 'Not found',\n        source_urls: scrapeResult.pages?.map(p => p.url) || [],\n        pages_scraped: scrapeResult.pages?.length || 0,\n        site_pages_discovered: siteMap.total_pages || 0\n      },\n      ...llmOutput,\n      requester_profile: {\n        summary: enrichmentResult.requester_profile?.summary || 'Not available',\n        conversation_angle: llmOutput.requester_profile?.conversation_angle || 'Focus on MyRecruiter value proposition'\n      }\n    };\n\n    console.log('[Synthesizer] Brief generated successfully with Claude');\n\n  } catch (error) {\n    console.log('[Synthesizer] Claude API error:', error.message);\n    runArtifact.errors.push(`LLM synthesis error: ${error.message}`);\n    throw error;\n  }\n\n  runArtifact.llm_output = `s3://deal-prep-artifacts/deal-prep/${runId}/brief.json`;\n\n  console.log('[Synthesizer] Completed');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      siteMap,\n      scrapeResult,\n      enrichmentResult,\n      brief\n    }\n  }];"
            },
            "id": "a713684d-36fb-4050-9fb8-fec684498630",
            "name": "LLM Synthesis",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2080,
                256
            ]
        },
        {
            "parameters": {
                "jsCode": "/**\n * Validate Brief Node\n * \n * Calls validateBrief() per Implementation Spec Section 9.3.\n * If invalid, logs errors and continues with warnings.\n * \n * Hard Constraints (spec 9.3):\n * - Exactly 3 top opportunities\n * - Exactly 3 AI opportunities\n * - Exactly 3 objections/rebuttals\n * - Executive summary <= 600 chars\n * - Opening script <= 450 chars\n * - Demo plan <= 6 steps\n * - Short email <= 120 words\n * - Warm email <= 180 words\n */\n\nconst { normalized, runId, runArtifact, orgIdentifier, scrapeResult, enrichmentResult, brief } = $('LLM Synthesis').first().json;\n\nfunction countWords(text) {\n  if (!text) return 0;\n  return text.split(/\\s+/).filter(w => w.length > 0).length;\n}\n\nfunction validateBrief(brief) {\n  const errors = [];\n  const warnings = [];\n  \n  // Check required structure\n  if (!brief?.meta?.run_id) errors.push('Missing meta.run_id');\n  if (!brief?.meta?.generated_at) errors.push('Missing meta.generated_at');\n  \n  // Exactly 3 top opportunities (spec 9.3)\n  if (brief.executive_summary?.top_opportunities?.length !== 3) {\n    errors.push(`top_opportunities must have exactly 3 items, got ${brief.executive_summary?.top_opportunities?.length || 0}`);\n  }\n  \n  // Exactly 3 AI opportunities (spec 9.3)\n  if (!brief.myrecruiter_opportunities || brief.myrecruiter_opportunities.length !== 3) {\n    errors.push(`AI opportunities must have exactly 3 items, got ${brief.myrecruiter_opportunities?.length || 0}`);\n  }\n  \n  // Exactly 3 objections/rebuttals (spec 9.3)\n  if (brief.objections_and_rebuttals?.length !== 3) {\n    errors.push(`objections_and_rebuttals must have exactly 3 items, got ${brief.objections_and_rebuttals?.length || 0}`);\n  }\n  \n  // Executive summary <= 600 chars\n  const summaryLength = brief.executive_summary?.summary?.length || 0;\n  if (summaryLength > 600) {\n    errors.push(`Executive summary exceeds 600 chars (got ${summaryLength})`);\n  }\n  \n  // Opening script <= 450 chars\n  const scriptLength = brief.opening_script?.length || 0;\n  if (scriptLength > 450) {\n    errors.push(`Opening script exceeds 450 chars (got ${scriptLength})`);\n  }\n  \n  // Demo plan <= 6 steps\n  const stepsCount = brief.demonstration_plan?.steps?.length || 0;\n  if (stepsCount > 6) {\n    errors.push(`Demonstration plan exceeds 6 steps (got ${stepsCount})`);\n  }\n  \n  // Short email <= 120 words\n  const shortEmailWords = countWords(brief.follow_up_emails?.short_version?.body);\n  if (shortEmailWords > 120) {\n    warnings.push(`Short email body exceeds 120 words (got ${shortEmailWords})`);\n  }\n  \n  // Warm email <= 180 words\n  const warmEmailWords = countWords(brief.follow_up_emails?.warm_version?.body);\n  if (warmEmailWords > 180) {\n    warnings.push(`Warm email body exceeds 180 words (got ${warmEmailWords})`);\n  }\n  \n  // Check for \"Not found\" placeholders (warning only)\n  if (brief.meta?.organization_name === 'Not found' && brief.meta?.organization_website === 'Not found') {\n    warnings.push('Both organization name and website are Not found');\n  }\n  \n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings\n  };\n}\n\n// Execute validation\nconst validationResult = validateBrief(brief);\n\nconsole.log('[Validator] Valid:', validationResult.valid);\nconsole.log('[Validator] Errors:', validationResult.errors.length);\nconsole.log('[Validator] Warnings:', validationResult.warnings.length);\n\n// Log validation issues to run artifact\nif (validationResult.errors.length > 0) {\n  runArtifact.errors.push(`Validation errors: ${validationResult.errors.join('; ')}`);\n}\nif (validationResult.warnings.length > 0) {\n  runArtifact.errors.push(`Validation warnings: ${validationResult.warnings.join('; ')}`);\n}\n\n// Continue execution even if validation fails (per spec, log and continue)\nreturn [{\n  json: {\n    normalized,\n    runId,\n    runArtifact,\n    orgIdentifier,\n    scrapeResult,\n    enrichmentResult,\n    brief,\n    validationResult\n  }\n}];"
            },
            "id": "626bfd19-f57d-47c6-9194-7f1e77212113",
            "name": "Validate Brief",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2736,
                256
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "/**\n   * Render Outputs Node\n   * \n   * Calls renderCRMNote(), renderEmail(), renderMotionTask().\n   * Stores rendered outputs.\n   */\n\n  const input = $('LLM Synthesis').first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {}, routing: {} };\n  normalized.routing = normalized.routing || {};\n  normalized.meta = normalized.meta || {};  const runId = normalized.meta.run_id || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [], rendered_outputs: {} };\n  runArtifact.errors = runArtifact.errors || [];\n  const brief = input.brief || { meta: {}, executive_summary: {}, organization_understanding: {}, artificial_intelligence_opportunities: [], objections_and_rebuttals: [], demonstration_plan: {} };\n\n  // CRM Renderer\n  function renderForCRM(brief) {\n    const meta = brief.meta || {};\n    const execSummary = brief.executive_summary || {};\n    const orgUnderstanding = brief.organization_understanding || {};\n    const aiOpps = brief.artificial_intelligence_opportunities || [];\n    const objections = brief.objections_and_rebuttals || [];\n\n    const sections = [\n      `# Deal Preparation Brief`,\n      `## Meta`,\n      `- Run ID: ${meta.run_id || 'unknown'}`,\n      `- Generated: ${meta.generated_at || 'unknown'}`,\n      `- Trigger: ${meta.trigger_source || 'unknown'}`,\n      `- Organization: ${meta.organization_name || 'unknown'}`,\n      `- Website: ${meta.organization_website || 'unknown'}`,\n      `- Contact: ${meta.requester_name || 'unknown'} (${meta.requester_title || 'unknown'})`,\n      ``,\n      `## Executive Summary`,\n      execSummary.summary || 'No summary available',\n      ``,\n      `### Top Opportunities`,\n      ...(execSummary.top_opportunities || []).map((o, i) => `${i + 1}. ${o}`),\n      ``,\n      `## Organization Understanding`,\n      `**Mission:** ${orgUnderstanding.mission || 'Not found'}`,\n      ``,\n      `### Programs`,\n      ...(orgUnderstanding.programs || []).map(p => `- **${p.name}:** ${p.summary}`),\n      ``,\n      `### Audiences`,\n      ...(orgUnderstanding.audiences || []).map(a => `- ${a}`),\n      ``,\n      `## AI Opportunities`,\n      ...aiOpps.map((o, i) => [\n        `### ${i + 1}. ${o.title}`,\n        `**Why it matters:** ${o.why_it_matters}`,\n        `**Demo hook:** ${o.demonstration_hook}`,\n        ``\n      ]).flat(),\n      `## Objections & Rebuttals`,\n      ...objections.map((o, i) => [\n        `### Objection ${i + 1}: \"${o.objection}\"`,\n        `**Rebuttal:** ${o.rebuttal}`,\n        ``\n      ]).flat(),\n      `## Opening Script`,\n      brief.opening_script || 'No script available'\n    ];\n\n    return {\n      format: 'markdown',\n      content: sections.join('\\n'),\n      run_id: meta.run_id || 'unknown'\n    };\n  }\n\n  // Email Renderer\n  function renderForEmail(brief, inputData) {\n    const meta = brief.meta || {};\n    const execSummary = brief.executive_summary || {};\n    const routing = inputData.routing || {};\n\n    return {\n      to: routing.email_to || null,\n      cc: routing.email_cc || [],\n      subject: `Deal Prep Brief: ${meta.organization_name || 'Organization'}`,\n      body_html: `\n        <h2>Deal Preparation Brief</h2>\n        <p><strong>Organization:</strong> ${meta.organization_name || 'Unknown'}</p>\n        <p><strong>Website:</strong> <a href=\"${meta.organization_website || '#'}\">${meta.organization_website || 'Unknown'}</a></p>\n        <p><strong>Contact:</strong> ${meta.requester_name || 'Unknown'} (${meta.requester_title || 'Unknown'})</p>\n        \n        <h3>Executive Summary</h3>\n        <p>${execSummary.summary || 'No summary available'}</p>\n        \n        <h3>Top 3 Opportunities</h3>\n        <ol>\n          ${(execSummary.top_opportunities || []).map(o => `<li>${o}</li>`).join('')}\n        </ol>\n        \n        <p><em>Full brief available in CRM. Run ID: ${meta.run_id || 'unknown'}</em></p>\n      `,\n      body_text: `\n  Deal Preparation Brief\n\n  Organization: ${meta.organization_name || 'Unknown'}\n  Website: ${meta.organization_website || 'Unknown'}\n  Contact: ${meta.requester_name || 'Unknown'} (${meta.requester_title || 'Unknown'})\n\n  Executive Summary:\n  ${execSummary.summary || 'No summary available'}\n\n  Top 3 Opportunities:\n  ${(execSummary.top_opportunities || []).map((o, i) => `${i + 1}. ${o}`).join('\\n')}\n\n  Full brief available in CRM. Run ID: ${meta.run_id || 'unknown'}\n      `,\n      run_id: meta.run_id || 'unknown'\n    };\n  }\n\n  // Motion Task Renderer\n  function renderForMotion(brief, inputData) {\n    const meta = brief.meta || {};\n    const execSummary = brief.executive_summary || {};\n    const aiOpps = brief.artificial_intelligence_opportunities || [];\n    const demoPlan = brief.demonstration_plan || {};\n    const routing = inputData.routing || {};\n    const inputMeta = inputData.meta || {};\n\n    const meetingTime = inputMeta.requested_meeting_at;\n    let dueDate = null;\n\n    if (meetingTime) {\n      const meetingDate = new Date(meetingTime);\n      meetingDate.setHours(meetingDate.getHours() - 2);\n      dueDate = meetingDate.toISOString();\n    }\n\n    return {\n      title: `Deal Prep - ${meta.organization_name || 'Organization'}`,\n      body: `\n  ## Top Opportunities\n  ${(execSummary.top_opportunities || []).map((o, i) => `${i + 1}. ${o}`).join('\\n')}\n\n  ## Key Talking Points\n  - ${demoPlan.opening || 'Prepare opening remarks'}\n  - Focus on: ${aiOpps.map(a => a.title).join(', ') || 'AI opportunities'}\n\n  ## Run ID\n  ${meta.run_id || 'unknown'}\n\n  [Full brief in CRM]\n      `,\n      workspace: routing.motion_workspace || null,\n      due_date: dueDate,\n      run_id: meta.run_id || 'unknown'\n    };\n  }\n\n  // Execute renderers\n  const crmOutput = renderForCRM(brief);\n  const emailOutput = renderForEmail(brief, normalized);\n  const motionOutput = renderForMotion(brief, normalized);\n\n  console.log('[Renderer] CRM output generated:', crmOutput.content.length, 'chars');\n  console.log('[Renderer] Email output generated');\n  console.log('[Renderer] Motion task output generated');\n\n  // Update run artifact\n  runArtifact.rendered_outputs = {\n    crm: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-crm.json`,\n    email: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-email.json`,\n    motion: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-motion.json`,\n    markdown: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-markdown.md`\n  };\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      brief,\n      renderedOutputs: {\n        crm: crmOutput,\n        email: emailOutput,\n        motion: motionOutput\n      }\n    }\n  }];"
            },
            "id": "f205dd03-46cd-4451-876a-e68708d63be4",
            "name": "Render Outputs",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2960,
                256
            ]
        },
        {
            "parameters": {
                "jsCode": "/**\n * Execute Deliveries Node\n * \n * Calls executeDeliveries() with all adapters.\n * Uses Promise.allSettled for independence.\n * Updates run artifact with delivery status.\n * \n * Implementation Spec Section 11 & 12: Delivery Tracking and External Interfaces\n */\n\nconst { normalized, runId, runArtifact, brief, renderedOutputs } = $input.first().json;\n\n// Delivery adapter stubs - in production, use actual adapters\nasync function deliverToCRM(crmOutput, routing) {\n  try {\n    console.log('[CRM Adapter] Delivering to CRM...');\n    // In production:\n    // await crmAdapter.upsertOrganization(crmOutput);\n    // await crmAdapter.attachBrief(crmOutput);\n    \n    // Simulated success\n    return { success: true, message: 'CRM delivery successful' };\n  } catch (error) {\n    return { success: false, error: error.message };\n  }\n}\n\nasync function deliverEmail(emailOutput, routing) {\n  try {\n    console.log('[Email Adapter] Sending email...');\n    // In production:\n    // await emailAdapter.send(emailOutput);\n    \n    if (!routing.email_to) {\n      return { success: false, error: 'No email recipient configured' };\n    }\n    \n    // Simulated success\n    return { success: true, message: `Email sent to ${routing.email_to}` };\n  } catch (error) {\n    return { success: false, error: error.message };\n  }\n}\n\nasync function deliverToMotion(motionOutput, routing) {\n  try {\n    console.log('[Motion Adapter] Creating task...');\n    // In production:\n    // await motionAdapter.createTask(motionOutput);\n    \n    if (!routing.motion_workspace) {\n      return { success: false, error: 'No Motion workspace configured' };\n    }\n    \n    // Simulated success\n    return { success: true, message: 'Motion task created' };\n  } catch (error) {\n    return { success: false, error: error.message };\n  }\n}\n\n// Execute all deliveries in parallel using Promise.allSettled (spec 11.3)\nconst deliveryPromises = [\n  deliverToCRM(renderedOutputs.crm, normalized.routing),\n  deliverEmail(renderedOutputs.email, normalized.routing),\n  deliverToMotion(renderedOutputs.motion, normalized.routing)\n];\n\nconst results = await Promise.allSettled(deliveryPromises);\nconst [crmResult, emailResult, motionResult] = results;\n\nconst now = new Date().toISOString();\n\n// Update delivery status in run artifact (spec 11.2)\nrunArtifact.deliveries = {\n  customer_relationship_management: {\n    status: crmResult.status === 'fulfilled' && crmResult.value.success ? 'success' : 'failed',\n    attempted_at: now,\n    error: crmResult.status === 'fulfilled' ? (crmResult.value.error || null) : crmResult.reason?.message\n  },\n  email: {\n    status: emailResult.status === 'fulfilled' && emailResult.value.success ? 'success' : 'failed',\n    attempted_at: now,\n    error: emailResult.status === 'fulfilled' ? (emailResult.value.error || null) : emailResult.reason?.message\n  },\n  motion: {\n    status: motionResult.status === 'fulfilled' && motionResult.value.success ? 'success' : 'failed',\n    attempted_at: now,\n    error: motionResult.status === 'fulfilled' ? (motionResult.value.error || null) : motionResult.reason?.message\n  }\n};\n\nconsole.log('[Delivery] CRM:', runArtifact.deliveries.customer_relationship_management.status);\nconsole.log('[Delivery] Email:', runArtifact.deliveries.email.status);\nconsole.log('[Delivery] Motion:', runArtifact.deliveries.motion.status);\n\nreturn [{\n  json: {\n    normalized,\n    runId,\n    runArtifact,\n    brief,\n    renderedOutputs,\n    deliveryResults: {\n      crm: crmResult,\n      email: emailResult,\n      motion: motionResult\n    }\n  }\n}];"
            },
            "id": "58f08dd0-7e67-47fb-a03e-69f39195ebd5",
            "name": "Execute Deliveries",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3632,
                256
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "/**\n   * Finalize Run Node\n   * \n   * Updates run artifact with completed_at.\n   * Calculates final status based on all delivery outcomes.\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { organization: {}, meta: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || {};\n  runArtifact.errors = runArtifact.errors || [];\n  runArtifact.metadata = runArtifact.metadata || {};\n  runArtifact.deliveries = runArtifact.deliveries || {\n    customer_relationship_management: { status: 'not_attempted' },\n    email: { status: 'not_attempted' },\n    motion: { status: 'not_attempted' }\n  };\n  const brief = input.brief || { executive_summary: {} };\n  const renderedOutputs = input.renderedOutputs || {};\n  const deliveryResults = input.deliveryResults || {};\n\n  // Calculate final status\n  function calculateFinalStatus(deliveries, errors) {\n    const crm = deliveries.customer_relationship_management || { status: 'not_attempted' };\n    const email = deliveries.email || { status: 'not_attempted' };\n    const motion = deliveries.motion || { status: 'not_attempted' };\n\n    const statuses = [crm.status, email.status, motion.status];\n\n    const successCount = statuses.filter(s => s === 'success').length;\n    const failedCount = statuses.filter(s => s === 'failed').length;\n\n    if (errors.length > 0 && successCount === 0) {\n      return 'failed';\n    }\n    if (failedCount === 3) {\n      return 'failed';\n    }\n    if (successCount === 3) {\n      return 'completed';\n    }\n    return 'completed_with_errors';\n  }\n\n  // Finalize run artifact\n  runArtifact.completed_at = new Date().toISOString();\n  runArtifact.started_at = runArtifact.started_at || normalized.meta?.received_at || new Date().toISOString();\n  runArtifact.status = calculateFinalStatus(runArtifact.deliveries, runArtifact.errors);\n\n  // Calculate duration\n  const startTime = new Date(runArtifact.started_at).getTime();\n  const endTime = new Date(runArtifact.completed_at).getTime();\n  runArtifact.metadata.duration_ms = endTime - startTime;\n  runArtifact.trigger_source = runArtifact.trigger_source || normalized.meta?.trigger_source || 'unknown';\n\n  console.log('[Finalize] Run completed');\n  console.log('[Finalize] Status:', runArtifact.status);\n  console.log('[Finalize] Duration:', runArtifact.metadata.duration_ms, 'ms');\n  console.log('[Finalize] Errors:', runArtifact.errors.length);\n\n  // Log metrics\n  const metrics = {\n    run_id: runId,\n    status: runArtifact.status,\n    duration_ms: runArtifact.metadata.duration_ms,\n    trigger_source: runArtifact.trigger_source,\n    organization: normalized.organization?.name || normalized.organization?.domain || 'unknown',\n    deliveries: {\n      crm: runArtifact.deliveries.customer_relationship_management?.status || 'not_attempted',\n      email: runArtifact.deliveries.email?.status || 'not_attempted',\n      motion: runArtifact.deliveries.motion?.status || 'not_attempted'\n    },\n    error_count: runArtifact.errors.length,\n    timestamp: runArtifact.completed_at\n  };\n\n  console.log('[Metrics]', JSON.stringify(metrics));\n\n  return [{\n    json: {\n      success: runArtifact.status !== 'failed',\n      runId,\n      status: runArtifact.status,\n      runArtifact,\n      brief,\n      metrics\n    }\n  }];"
            },
            "id": "0edbffc6-aefb-45d9-8e78-40a69207beb6",
            "name": "Finalize Run",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3856,
                256
            ]
        },
        {
            "parameters": {
                "jsCode": "// Skip node - run was already completed (idempotency check)\n// With responseMode: onReceived, we can't respond again\n// Just log and end the flow\nconsole.log('[Skip] Run already completed, skipping duplicate execution');\nreturn [];"
            },
            "id": "85f28568-d8f3-468f-b558-16752fb11232",
            "name": "Skip (Already Complete)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1408,
                64
            ]
        },
        {
            "parameters": {
                "jsCode": "// End of workflow - with responseMode: onReceived, webhook already responded\n// Log completion for monitoring\nconst input = $input.first().json;\nconsole.log('[Complete] Workflow finished for run:', input.runId || 'unknown');\nconsole.log('[Complete] Status:', input.runArtifact?.status || 'unknown');\nreturn [{ json: { completed: true, runId: input.runId } }];"
            },
            "id": "0df60204-a094-4052-852e-07776cd39359",
            "name": "Log Completion",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4080,
                256
            ]
        },
        {
            "parameters": {
                "content": "## Level 2 Deal Preparation Pipeline\n\nThis workflow implements the complete Deal Prep pipeline per the AI_Deal_Prep_Implementation_Spec.\n\n### Trigger Options:\n- **Webhook (Inbound)**: POST /deal-prep with JSON body\n- **Manual (Outbound)**: Click \"Execute\" for outbound prospecting\n\n### Pipeline Steps:\n1. Normalize Input\n2. Generate Run ID (idempotency)\n3. Initialize Run Artifact\n4. Website Scrape (with retry)\n5. Person Enrichment (non-blocking)\n6. LLM Synthesis (Claude)\n7. Validate Brief\n8. Render Outputs (CRM, Email, Motion)\n9. Execute Deliveries\n10. Finalize Run",
                "height": 380,
                "width": 300
            },
            "id": "f191e0af-8ef3-4ca3-94ed-21696068dea3",
            "name": "Sticky Note",
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                0,
                0
            ]
        },
        {
            "parameters": {
                "content": "### Error Handling\n\n- Scrape: 2 retries (30s, 120s backoff)\n- Enrichment: Non-blocking, always continues\n- LLM: 1 retry on validation failure\n- Deliveries: Independent (Promise.allSettled)\n- All errors logged to run artifact",
                "width": 260
            },
            "id": "f3ecea55-03f6-4cec-a025-1816e469d8b5",
            "name": "Error Handling Note",
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                1600,
                64
            ]
        },
        {
            "parameters": {
                "content": "### Observability\n\n- Console logs with [Module] prefix\n- Metrics emitted at finalization\n- All artifacts stored to S3\n- Run duration tracked",
                "height": 140
            },
            "id": "7b07cf9b-5dce-4269-b571-794b527591f8",
            "name": "Observability Note",
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                2928,
                64
            ]
        },
        {
            "parameters": {
                "jsCode": "// Log AI Ideas - Extract and format AI opportunities for product roadmap\n  const runArtifact = $input.first().json.runArtifact || {};\n  const validatedBrief = $input.first().json.brief || $input.first().json.validatedBrief || {};\n\n  // Extract data\n  const organizationName = validatedBrief.meta?.organization_name || runArtifact.organization?.name || 'Unknown Organization';\n  const organizationWebsite = validatedBrief.meta?.organization_website || runArtifact.organization?.website || '';\n  const contactName = validatedBrief.meta?.requester_name || runArtifact.contact?.full_name || '';\n  const runId = runArtifact.run_id || 'unknown';\n  const generatedAt = new Date().toISOString();\n\n  // Get MyRecruiter opportunities from the brief\n  const myrecruiterOpportunities = validatedBrief.myrecruiter_opportunities || [];\n\n  // Get Blue Sky ideas from the brief\n  const blueSkyIdeas = validatedBrief.blue_sky_ideas || [];\n\n  // Determine organization type from content\n  const missionText = (validatedBrief.organization_understanding?.mission || '').toLowerCase();\n  let orgType = 'nonprofit';\n  if (missionText.includes('mentor')) orgType = 'mentoring';\n  else if (missionText.includes('food') || missionText.includes('hunger')) orgType = 'food-security';\n  else if (missionText.includes('education') || missionText.includes('school')) orgType = 'education';\n  else if (missionText.includes('health') || missionText.includes('medical')) orgType = 'healthcare';\n  else if (missionText.includes('environment') || missionText.includes('climate')) orgType = 'environmental';\n\n  // Assess feasibility for MyRecruiter opportunities\n  function assessFeasibility(opp) {\n    const text = (opp.title + ' ' + (opp.myrecruiter_solution || opp.why_it_matters || '')).toLowerCase();\n    if (text.includes('chatbot') || text.includes('faq') || text.includes('lead capture') ||\n        text.includes('form') || text.includes('24/7') || text.includes('knowledge base') ||\n        text.includes('conversational') || text.includes('qualification')) {\n      return 'high';\n    } else if (text.includes('integration') || text.includes('crm') || text.includes('routing') ||\n               text.includes('analytics') || text.includes('reporting')) {\n      return 'medium';\n    }\n    return 'low';\n  }\n\n  // Process MyRecruiter opportunities with feasibility\n  const processedMyRecruiterOpps = myrecruiterOpportunities.map(opp => ({\n    ...opp,\n    feasibility: assessFeasibility(opp)\n  }));\n\n  // Count by feasibility\n  const highCount = processedMyRecruiterOpps.filter(o => o.feasibility === 'high').length;\n  const mediumCount = processedMyRecruiterOpps.filter(o => o.feasibility === 'medium').length;\n  const lowCount = processedMyRecruiterOpps.filter(o => o.feasibility === 'low').length;\n\n  // Create org identifier for S3 path\n  const orgIdentifier = organizationName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'unknown';\n\n  // Build the AI Ideas log object\n  const aiIdeasLog = {\n    metadata: {\n      organization_name: organizationName,\n      organization_website: organizationWebsite,\n      contact_name: contactName,\n      run_id: runId,\n      generated_at: generatedAt,\n      organization_type: orgType,\n      pages_analyzed: validatedBrief.meta?.pages_scraped || 0\n    },\n    myrecruiter_opportunities: processedMyRecruiterOpps,\n    blue_sky_ideas: blueSkyIdeas,\n    summary: {\n      total_myrecruiter_opportunities: myrecruiterOpportunities.length,\n      total_blue_sky_ideas: blueSkyIdeas.length,\n      feasibility_breakdown: {\n        high: highCount,\n        medium: mediumCount,\n        low: lowCount\n      }\n    }\n  };\n\n  // Generate HTML document\n  const aiIdeasHtml = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"UTF-8\">\n      <title>AI Ideas Log - ${organizationName}</title>\n      <style>\n        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');\n        \n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        \n        body {\n          font-family: 'Plus Jakarta Sans', Arial, sans-serif;\n          font-size: 11pt;\n          line-height: 1.6;\n          color: #1e293b;\n          background: #f8fafc;\n        }\n        \n        .header {\n          background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);\n          color: white;\n          padding: 30px 40px;\n        }\n        \n        .header-top {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-bottom: 15px;\n        }\n        \n        .logo {\n          font-size: 24pt;\n          font-weight: 700;\n          display: flex;\n          align-items: center;\n          gap: 12px;\n        }\n        \n        .logo-icon {\n          width: 44px;\n          height: 44px;\n        }\n        \n        .logo-my { color: #50C878; }\n        .logo-recruiter { color: white; }\n        \n        .doc-type {\n          font-size: 10pt;\n          color: #94a3b8;\n          text-transform: uppercase;\n          letter-spacing: 1px;\n        }\n        \n        .org-name {\n          font-size: 24pt;\n          font-weight: 700;\n          margin-bottom: 5px;\n        }\n        \n        .org-website {\n          font-size: 11pt;\n          color: #50C878;\n        }\n        \n        .meta-bar {\n          background: white;\n          padding: 15px 40px;\n          border-bottom: 1px solid #e2e8f0;\n          display: flex;\n          gap: 30px;\n          font-size: 10pt;\n          flex-wrap: wrap;\n        }\n        \n        .meta-item { color: #64748b; }\n        .meta-item strong { color: #1e293b; }\n        \n        .content {\n          padding: 30px 40px;\n          max-width: 1100px;\n          margin: 0 auto;\n        }\n        \n        .summary-cards {\n          display: flex;\n          gap: 15px;\n          margin-bottom: 30px;\n          flex-wrap: wrap;\n        }\n        \n        .summary-card {\n          flex: 1;\n          min-width: 120px;\n          background: white;\n          border-radius: 10px;\n          padding: 20px;\n          text-align: center;\n          box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        }\n        \n        .summary-card .number {\n          font-size: 28pt;\n          font-weight: 700;\n          color: #1e293b;\n        }\n        \n        .summary-card .number.high { color: #10b981; }\n        .summary-card .number.medium { color: #f59e0b; }\n        .summary-card .number.low { color: #ef4444; }\n        .summary-card .number.blue-sky { color: #8b5cf6; }\n        \n        .summary-card .label {\n          font-size: 9pt;\n          color: #64748b;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n          margin-top: 5px;\n        }\n        \n        .section-title {\n          font-size: 14pt;\n          font-weight: 700;\n          color: #0f172a;\n          margin: 30px 0 20px 0;\n          padding-bottom: 10px;\n          border-bottom: 2px solid #50C878;\n          display: flex;\n          align-items: center;\n          gap: 10px;\n        }\n        \n        .section-title.blue-sky {\n          border-bottom-color: #8b5cf6;\n        }\n        \n        .section-icon {\n          width: 24px;\n          height: 24px;\n        }\n        \n        .opportunity-card {\n          background: white;\n          border-radius: 10px;\n          padding: 25px;\n          margin-bottom: 20px;\n          box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n          border-left: 4px solid #50C878;\n        }\n        \n        .opportunity-card.blue-sky {\n          border-left-color: #8b5cf6;\n          background: linear-gradient(135deg, #faf5ff 0%, #ffffff 100%);\n        }\n        \n        .opp-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: flex-start;\n          margin-bottom: 15px;\n          flex-wrap: wrap;\n          gap: 10px;\n        }\n        \n        .opp-title {\n          font-size: 13pt;\n          font-weight: 700;\n          color: #0f172a;\n          flex: 1;\n        }\n        \n        .feasibility-badge {\n          font-size: 9pt;\n          padding: 4px 12px;\n          border-radius: 20px;\n          font-weight: 600;\n          white-space: nowrap;\n        }\n        \n        .feasibility-high {\n          background: #d1fae5;\n          color: #065f46;\n        }\n        \n        .feasibility-medium {\n          background: #fef3c7;\n          color: #92400e;\n        }\n        \n        .feasibility-low {\n          background: #fee2e2;\n          color: #991b1b;\n        }\n        \n        .badge-blue-sky {\n          background: #ede9fe;\n          color: #5b21b6;\n        }\n        \n        .opp-section {\n          margin-bottom: 15px;\n        }\n        \n        .opp-section:last-child {\n          margin-bottom: 0;\n        }\n        \n        .opp-section-label {\n          font-size: 9pt;\n          font-weight: 600;\n          color: #50C878;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n          margin-bottom: 5px;\n        }\n        \n        .opp-section-label.blue-sky {\n          color: #8b5cf6;\n        }\n        \n        .opp-section-content {\n          font-size: 10.5pt;\n          color: #334155;\n          line-height: 1.7;\n        }\n        \n        .solution-box {\n          background: #f0fdf4;\n          border-radius: 8px;\n          padding: 15px;\n          font-size: 10.5pt;\n          color: #166534;\n          border: 1px solid #bbf7d0;\n        }\n        \n        .solution-box.blue-sky {\n          background: #faf5ff;\n          color: #5b21b6;\n          border-color: #ddd6fe;\n        }\n        \n        .roadmap-box {\n          background: #fef3c7;\n          border-radius: 8px;\n          padding: 15px;\n          font-size: 10.5pt;\n          color: #92400e;\n          border: 1px solid #fde68a;\n        }\n        \n        .demo-box {\n          background: #fdf4ff;\n          border-radius: 8px;\n          padding: 15px;\n          font-size: 10.5pt;\n          color: #86198f;\n          border: 1px solid #f5d0fe;\n        }\n        \n        .context-section {\n          background: #f1f5f9;\n          border-radius: 10px;\n          padding: 25px;\n          margin-top: 30px;\n        }\n        \n        .context-grid {\n          display: grid;\n          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n          gap: 20px;\n          margin-top: 15px;\n        }\n        \n        .context-item {\n          text-align: center;\n        }\n        \n        .context-value {\n          font-size: 14pt;\n          font-weight: 700;\n          color: #0f172a;\n        }\n        \n        .context-label {\n          font-size: 9pt;\n          color: #64748b;\n          text-transform: uppercase;\n          margin-top: 5px;\n        }\n        \n        .divider {\n          height: 2px;\n          background: linear-gradient(90deg, #50C878 0%, #8b5cf6 100%);\n          margin: 40px 0;\n          border-radius: 2px;\n        }\n        \n        .footer {\n          text-align: center;\n          padding: 20px;\n          color: #94a3b8;\n          font-size: 9pt;\n        }\n        \n        @media print {\n          body { background: white; }\n          .content { padding: 20px; }\n          .opportunity-card { break-inside: avoid; }\n        }\n      </style>\n    </head>\n    <body>\n    <div class=\"header\">\n      <div class=\"header-top\">\n        <div class=\"logo\">\n          <svg class=\"logo-icon\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\n            <circle cx=\"50\" cy=\"8\" r=\"8\" fill=\"#50C878\"/>\n            <circle cx=\"8\" cy=\"50\" r=\"8\" fill=\"#50C878\"/>\n            <circle cx=\"92\" cy=\"50\" r=\"8\" fill=\"#50C878\"/>\n            <circle cx=\"50\" cy=\"92\" r=\"8\" fill=\"#8b5cf6\"/>\n            <path d=\"M50 16 Q80 20 84 50 Q80 80 50 84\" stroke=\"#50C878\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n            <path d=\"M50 16 Q20 20 16 50 Q20 80 50 84\" stroke=\"#50C878\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n            <path d=\"M25 78 Q50 100 75 78\" stroke=\"#8b5cf6\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n            <circle cx=\"35\" cy=\"50\" r=\"7\" fill=\"#8b5cf6\"/>\n            <circle cx=\"50\" cy=\"50\" r=\"7\" fill=\"#8b5cf6\"/>\n            <circle cx=\"65\" cy=\"50\" r=\"7\" fill=\"#8b5cf6\"/>\n          </svg>\n          <span><span class=\"logo-my\">My</span><span class=\"logo-recruiter\">Recruiter</span></span>\n        </div>\n        <div class=\"doc-type\">AI Ideas Log \u2022 Product Roadmap</div>\n      </div>\n      <div class=\"org-name\">${organizationName}</div>\n      <div class=\"org-website\">${organizationWebsite}</div>\n    </div>\n\n    <div class=\"meta-bar\">\n      <div class=\"meta-item\"><strong>Contact:</strong> ${contactName}</div>\n      <div class=\"meta-item\"><strong>Generated:</strong> ${new Date(generatedAt).toLocaleString()}</div>\n      <div class=\"meta-item\"><strong>Run ID:</strong> ${runId}</div>\n      <div class=\"meta-item\"><strong>Org Type:</strong> ${orgType}</div>\n    </div>\n\n    <div class=\"content\">\n      \n      <div class=\"summary-cards\">\n        <div class=\"summary-card\">\n          <div class=\"number\">${myrecruiterOpportunities.length}</div>\n          <div class=\"label\">MyRecruiter Opps</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number blue-sky\">${blueSkyIdeas.length}</div>\n          <div class=\"label\">Blue Sky Ideas</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number high\">${highCount}</div>\n          <div class=\"label\">High Feasibility</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number medium\">${mediumCount}</div>\n          <div class=\"label\">Medium Feasibility</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number low\">${lowCount}</div>\n          <div class=\"label\">Low Feasibility</div>\n        </div>\n      </div>\n\n      <div class=\"section-title\">\n        <svg class=\"section-icon\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n          <path d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" stroke=\"#50C878\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n        </svg>\n        MyRecruiter Opportunities (Sell Today)\n      </div>\n      \n      ${processedMyRecruiterOpps.map((opp, i) => `\n      <div class=\"opportunity-card\">\n        <div class=\"opp-header\">\n          <div class=\"opp-title\">${i + 1}. ${opp.title || 'Untitled Opportunity'}</div>\n          <span class=\"feasibility-badge feasibility-${opp.feasibility}\">${opp.feasibility === 'high' ? '\u2713 High - Core Feature' : opp.feasibility === 'medium' ? '\u25d0 Medium - With Integration' : '\u25cb Low - Custom Work'}</span>\n        </div>\n        \n        ${opp.why_it_matters ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label\">Why It Matters</div>\n          <div class=\"opp-section-content\">${opp.why_it_matters}</div>\n        </div>\n        ` : ''}\n        \n        ${opp.myrecruiter_solution ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label\">MyRecruiter Solution</div>\n          <div class=\"solution-box\">${opp.myrecruiter_solution}</div>\n        </div>\n        ` : ''}\n        \n        ${opp.demonstration_hook ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label\">Demo Hook</div>\n          <div class=\"demo-box\">${opp.demonstration_hook}</div>\n        </div>\n        ` : ''}\n      </div>\n      `).join('')}\n\n      <div class=\"divider\"></div>\n\n      <div class=\"section-title blue-sky\">\n        <svg class=\"section-icon\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n          <path d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" stroke=\"#8b5cf6\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n        </svg>\n        Blue Sky Ideas (Product Roadmap)\n      </div>\n      \n      ${blueSkyIdeas.length > 0 ? blueSkyIdeas.map((idea, i) => `\n      <div class=\"opportunity-card blue-sky\">\n        <div class=\"opp-header\">\n          <div class=\"opp-title\">${i + 1}. ${idea.title || 'Untitled Idea'}</div>\n          <span class=\"feasibility-badge badge-blue-sky\">\ud83d\udca1 Future Feature</span>\n        </div>\n        \n        ${idea.why_it_matters ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label blue-sky\">Why It Matters</div>\n          <div class=\"opp-section-content\">${idea.why_it_matters}</div>\n        </div>\n        ` : ''}\n        \n        ${idea.ai_solution ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label blue-sky\">AI Solution</div>\n          <div class=\"solution-box blue-sky\">${idea.ai_solution}</div>\n        </div>\n        ` : ''}\n        \n        ${idea.roadmap_potential ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label blue-sky\">Roadmap Potential</div>\n          <div class=\"roadmap-box\">${idea.roadmap_potential}</div>\n        </div>\n        ` : ''}\n      </div>\n      `).join('') : `\n      <div class=\"opportunity-card blue-sky\">\n        <div class=\"opp-section-content\" style=\"text-align: center; padding: 20px; color: #64748b;\">\n          No blue sky ideas generated. Update the LLM Synthesis prompt to include the blue_sky_ideas schema.\n        </div>\n      </div>\n      `}\n\n      <div class=\"context-section\">\n        <div class=\"section-title\" style=\"margin-bottom: 0; border: none; padding: 0;\">Organization Context</div>\n        <div class=\"context-grid\">\n          <div class=\"context-item\">\n            <div class=\"context-value\">${orgType}</div>\n            <div class=\"context-label\">Organization Type</div>\n          </div>\n          <div class=\"context-item\">\n            <div class=\"context-value\">${validatedBrief.meta?.pages_scraped || 0}</div>\n            <div class=\"context-label\">Pages Analyzed</div>\n          </div>\n          <div class=\"context-item\">\n            <div class=\"context-value\">${myrecruiterOpportunities.length + blueSkyIdeas.length}</div>\n            <div class=\"context-label\">Total Ideas</div>\n          </div>\n          <div class=\"context-item\">\n            <div class=\"context-value\">${new Date(generatedAt).toLocaleDateString()}</div>\n            <div class=\"context-label\">Generated</div>\n          </div>\n        </div>\n      </div>\n      \n    </div>\n    \n    <div class=\"footer\">\n      Generated by MyRecruiter Deal Prep Pipeline \u2022 ${new Date(generatedAt).toLocaleString()} \u2022 Internal Use Only\n    </div>\n    </body>\n    </html>\n  `;\n\n  // Return everything needed for S3 upload\n  return {\n    runArtifact,\n    validatedBrief,\n    aiIdeasLog,\n    aiIdeasHtml,\n    orgIdentifier,\n    runId\n  };"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2304,
                256
            ],
            "id": "0b94a4aa-b933-4fa3-8384-33b3a37464c9",
            "name": "Log AI Ideas"
        },
        {
            "parameters": {
                "jsCode": "/**\n   * Generate PDF Node\n   * \n   * Creates a branded PDF brief using HTML template and stores to S3.\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [], rendered_outputs: {} };\n  runArtifact.errors = runArtifact.errors || [];\n  const brief = input.brief || input.validatedBrief || {};\n  const renderedOutputs = input.renderedOutputs || {};\n  const siteMap = input.siteMap || { sections: {}, total_pages: 0 };\n\n  // Create proper orgIdentifier from organization name\n  const organizationName = brief.meta?.organization_name || normalized.organization?.name || 'Unknown';\n  const orgIdentifier = input.orgIdentifier || organizationName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'unknown';\n\n  console.log('[PDFGen] Organization:', organizationName);\n  console.log('[PDFGen] Org Identifier:', orgIdentifier);\n  console.log('[PDFGen] Run ID:', runId);\n\n  // MyRecruiter branding\n  const BRAND = {\n    primaryColor: '#50C878',\n    accentPink: '#D98AD9',\n    darkBg: '#0f172a',\n    lightBg: '#f8fafc',\n    textDark: '#1e293b',\n    textMuted: '#64748b',\n    font: 'Plus Jakarta Sans, Arial, sans-serif'\n  };\n\n  function formatDate(isoString) {\n    const date = new Date(isoString);\n    return date.toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  }\n\n  function buildPDFHtml(brief, siteMap, brand) {\n    const meta = brief.meta || {};\n    const exec = brief.executive_summary || {};\n    const org = brief.organization_understanding || {};\n    const site = brief.site_structure || {};\n    const web = brief.website_analysis || {};\n    const leadership = brief.leadership_and_staff || {};\n    const opps = brief.myrecruiter_opportunities || brief.artificial_intelligence_opportunities || [];\n    const objections = brief.objections_and_rebuttals || [];\n    const demo = brief.demonstration_plan || {};\n    const emails = brief.follow_up_emails || {};\n\n    return `\n  <!DOCTYPE html>\n  <html>\n  <head>\n    <meta charset=\"UTF-8\">\n    <style>\n      @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');\n      \n      * { margin: 0; padding: 0; box-sizing: border-box; }\n      \n      body {\n        font-family: ${brand.font};\n        font-size: 11pt;\n        line-height: 1.5;\n        color: ${brand.textDark};\n      }\n      \n      .header {\n        background: linear-gradient(135deg, ${brand.darkBg} 0%, #1e293b 100%);\n        color: white;\n        padding: 30px 40px;\n        margin-bottom: 0;\n      }\n      \n      .header-top {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 20px;\n      }\n      \n      .logo {\n        font-size: 24pt;\n        font-weight: 700;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n      \n      .logo-icon {\n        width: 44px;\n        height: 44px;\n      }\n      \n      .logo-my {\n        color: ${brand.primaryColor};\n      }\n      \n      .logo-recruiter {\n        color: white;\n      }\n      \n      .doc-type {\n        font-size: 10pt;\n        color: #94a3b8;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n      }\n      \n      .org-name {\n        font-size: 28pt;\n        font-weight: 700;\n        margin-bottom: 8px;\n      }\n      \n      .org-website {\n        font-size: 12pt;\n        color: ${brand.primaryColor};\n      }\n      \n      .meta-bar {\n        background: ${brand.lightBg};\n        padding: 15px 40px;\n        border-bottom: 1px solid #e2e8f0;\n        display: flex;\n        gap: 40px;\n        font-size: 10pt;\n      }\n      \n      .meta-item { color: ${brand.textMuted}; }\n      .meta-item strong { color: ${brand.textDark}; }\n      \n      .content {\n        padding: 30px 40px;\n      }\n      \n      .section {\n        margin-bottom: 25px;\n        page-break-inside: avoid;\n      }\n      \n      .section-title {\n        font-size: 14pt;\n        font-weight: 700;\n        color: ${brand.darkBg};\n        border-bottom: 2px solid ${brand.primaryColor};\n        padding-bottom: 8px;\n        margin-bottom: 15px;\n      }\n      \n      .summary-box {\n        background: ${brand.lightBg};\n        border-left: 4px solid ${brand.primaryColor};\n        padding: 15px 20px;\n        margin-bottom: 15px;\n      }\n      \n      .opportunity {\n        background: white;\n        border: 1px solid #e2e8f0;\n        border-radius: 8px;\n        padding: 15px;\n        margin-bottom: 12px;\n      }\n      \n      .opp-number {\n        background: ${brand.primaryColor};\n        color: white;\n        width: 24px;\n        height: 24px;\n        border-radius: 50%;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        font-weight: 700;\n        font-size: 12pt;\n        margin-right: 10px;\n      }\n      \n      .opp-title {\n        font-weight: 600;\n        font-size: 12pt;\n        display: inline;\n      }\n      \n      .opp-detail {\n        margin-top: 8px;\n        padding-left: 34px;\n        font-size: 10pt;\n        color: ${brand.textMuted};\n      }\n      \n      .opp-solution {\n        background: #ecfdf5;\n        border-radius: 4px;\n        padding: 8px 12px;\n        margin-top: 8px;\n        margin-left: 34px;\n        font-size: 10pt;\n      }\n      \n      .opp-solution strong {\n        color: ${brand.primaryColor};\n      }\n      \n      .site-structure {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 10px;\n      }\n      \n      .site-section {\n        background: ${brand.lightBg};\n        padding: 10px;\n        border-radius: 6px;\n        font-size: 10pt;\n        min-width: 120px;\n      }\n      \n      .site-section-name {\n        font-weight: 600;\n        color: ${brand.darkBg};\n      }\n      \n      .site-section-count {\n        color: ${brand.textMuted};\n        font-size: 9pt;\n      }\n      \n      ul { padding-left: 20px; }\n      li { margin-bottom: 5px; }\n      \n      .two-col {\n        display: flex;\n        gap: 20px;\n      }\n      \n      .two-col > div {\n        flex: 1;\n      }\n      \n      .objection {\n        background: #fef2f2;\n        border-radius: 6px;\n        padding: 12px;\n        margin-bottom: 10px;\n      }\n      \n      .objection-q {\n        font-weight: 600;\n        color: #991b1b;\n        font-size: 10pt;\n      }\n      \n      .objection-a {\n        margin-top: 6px;\n        font-size: 10pt;\n        color: ${brand.textDark};\n      }\n      \n      .script-box {\n        background: #f0fdf4;\n        border: 1px solid ${brand.primaryColor};\n        border-radius: 8px;\n        padding: 15px;\n        font-style: italic;\n      }\n      \n      .footer {\n        background: ${brand.darkBg};\n        color: white;\n        padding: 15px 40px;\n        font-size: 9pt;\n        display: flex;\n        justify-content: space-between;\n        margin-top: 30px;\n      }\n      \n      .footer a {\n        color: ${brand.primaryColor};\n        text-decoration: none;\n      }\n    </style>\n  </head>\n  <body>\n\n  <div class=\"header\">\n    <div class=\"header-top\">\n      <div class=\"logo\">\n        <svg class=\"logo-icon\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\n          <circle cx=\"50\" cy=\"8\" r=\"8\" fill=\"${brand.primaryColor}\"/>\n          <circle cx=\"8\" cy=\"50\" r=\"8\" fill=\"${brand.primaryColor}\"/>\n          <circle cx=\"92\" cy=\"50\" r=\"8\" fill=\"${brand.primaryColor}\"/>\n          <circle cx=\"50\" cy=\"92\" r=\"8\" fill=\"${brand.accentPink}\"/>\n          <path d=\"M50 16 Q80 20 84 50 Q80 80 50 84\" stroke=\"${brand.primaryColor}\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n          <path d=\"M50 16 Q20 20 16 50 Q20 80 50 84\" stroke=\"${brand.primaryColor}\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n          <path d=\"M25 78 Q50 100 75 78\" stroke=\"${brand.accentPink}\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n          <circle cx=\"35\" cy=\"50\" r=\"7\" fill=\"${brand.accentPink}\"/>\n          <circle cx=\"50\" cy=\"50\" r=\"7\" fill=\"${brand.accentPink}\"/>\n          <circle cx=\"65\" cy=\"50\" r=\"7\" fill=\"${brand.accentPink}\"/>\n        </svg>\n        <span><span class=\"logo-my\">My</span><span class=\"logo-recruiter\">Recruiter</span></span>\n      </div>\n      <div class=\"doc-type\">Deal Preparation Brief</div>\n    </div>\n    <div class=\"org-name\">${meta.organization_name || 'Organization'}</div>\n    <div class=\"org-website\">${meta.organization_website || ''}</div>\n  </div>\n\n  <div class=\"meta-bar\">\n    <div class=\"meta-item\"><strong>Contact:</strong> ${meta.requester_name || 'N/A'}</div>\n    <div class=\"meta-item\"><strong>Generated:</strong> ${formatDate(meta.generated_at || new Date().toISOString())}</div>\n    <div class=\"meta-item\"><strong>Run ID:</strong> ${meta.run_id || 'N/A'}</div>\n    <div class=\"meta-item\"><strong>Pages Analyzed:</strong> ${meta.pages_scraped || 0}</div>\n  </div>\n\n  <div class=\"content\">\n\n    <div class=\"section\">\n      <div class=\"section-title\">Executive Summary</div>\n      <div class=\"summary-box\">${exec.summary || 'No summary available'}</div>\n      <strong>Top Opportunities:</strong>\n      <ol>\n        ${(exec.top_opportunities || []).map(o => '<li>' + o + '</li>').join('')}\n      </ol>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Organization Understanding</div>\n      <p><strong>Mission:</strong> ${org.mission || 'Not found'}</p>\n      ${org.programs && org.programs.length > 0 ? \n      '<p style=\"margin-top: 10px;\"><strong>Programs:</strong></p><ul>' +\n      org.programs.map(p => '<li><strong>' + p.name + ':</strong> ' + p.summary + '</li>').join('') +\n      '</ul>' : ''}\n      ${org.audiences && org.audiences.length > 0 ? \n      '<p style=\"margin-top: 10px;\"><strong>Target Audiences:</strong> ' + org.audiences.join(', ') + '</p>' : ''}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Website Analysis</div>\n      <p><strong>Overall Tone:</strong> ${web.overall_tone || 'Not analyzed'}</p>\n      <div class=\"two-col\" style=\"margin-top: 10px;\">\n        <div>\n          <strong>Strengths:</strong>\n          <ul>${(web.strengths || []).map(s => '<li>' + s + '</li>').join('')}</ul>\n        </div>\n        <div>\n          <strong>Gaps/Opportunities:</strong>\n          <ul>${(web.gaps || []).map(g => '<li>' + g + '</li>').join('')}</ul>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Leadership & Staff</div>\n      <p><strong>Executive Leader:</strong> ${leadership.executive_leader?.name || 'Not found'} ${leadership.executive_leader?.role ? '(' + leadership.executive_leader.role + ')' : ''}</p>\n      ${leadership.other_staff_mentions && leadership.other_staff_mentions.length > 0 ? \n      '<p style=\"margin-top: 8px;\"><strong>Other Staff:</strong></p><ul>' +\n      leadership.other_staff_mentions.map(s => '<li>' + s.name + ' - ' + s.role + '</li>').join('') +\n      '</ul>' : ''}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">MyRecruiter Opportunities</div>\n      ${opps.map(function(opp, i) {\n        return '<div class=\"opportunity\"><span class=\"opp-number\">' + (i + 1) + '</span><span class=\"opp-title\">' + opp.title + '</span><div class=\"opp-detail\">' + opp.why_it_matters + '</div>' + (opp.myrecruiter_solution ? '<div class=\"opp-solution\"><strong>MyRecruiter Solution:</strong> ' + opp.myrecruiter_solution + '</div>' : '') + '</div>';\n      }).join('')}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Objections & Rebuttals</div>\n      ${objections.map(function(obj) {\n        return '<div class=\"objection\"><div class=\"objection-q\">\"' + obj.objection + '\"</div><div class=\"objection-a\">' + obj.rebuttal + '</div></div>';\n      }).join('')}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Opening Script</div>\n      <div class=\"script-box\">${brief.opening_script || 'No script available'}</div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Demonstration Plan</div>\n      <p><strong>Opening:</strong> ${demo.opening || ''}</p>\n      <ol style=\"margin-top: 10px;\">\n        ${(demo.steps || []).map(s => '<li>' + s + '</li>').join('')}\n      </ol>\n      ${(demo.example_chatbot_responses || demo.example_bot_responses || []).length > 0 ? \n      '<p style=\"margin-top: 10px;\"><strong>Example Chatbot Responses:</strong></p><ul>' +\n      (demo.example_chatbot_responses || demo.example_bot_responses || []).map(r => '<li><em>\"' + r + '\"</em></li>').join('') +\n      '</ul>' : ''}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Follow-Up Emails</div>\n      <div class=\"two-col\">\n        <div>\n          <strong>Short Version:</strong>\n          <p style=\"margin-top: 5px;\"><em>Subject: ${emails.short_version?.subject || ''}</em></p>\n          <p style=\"font-size: 10pt; margin-top: 5px;\">${emails.short_version?.body || ''}</p>\n        </div>\n        <div>\n          <strong>Warm Version:</strong>\n          <p style=\"margin-top: 5px;\"><em>Subject: ${emails.warm_version?.subject || ''}</em></p>\n          <p style=\"font-size: 10pt; margin-top: 5px;\">${emails.warm_version?.body || ''}</p>\n        </div>\n      </div>\n    </div>\n\n  </div>\n\n  <div class=\"footer\">\n    <div>Generated by <a href=\"https://myrecruiter.ai\"><span style=\"color: ${brand.primaryColor};\">My</span><span style=\"color: white;\">Recruiter</span>.ai</a></div>\n    <div>Run ID: ${meta.run_id || 'N/A'}</div>\n  </div>\n\n  </body>\n  </html>\n  `;\n  }\n\n  const pdfHtml = buildPDFHtml(brief, siteMap, BRAND);\n\n  const pdfData = {\n    html: pdfHtml,\n    filename: `deal-prep-brief-${orgIdentifier}-${runId}.pdf`,\n    generated_at: new Date().toISOString()\n  };\n\n  runArtifact.rendered_outputs = runArtifact.rendered_outputs || {};\n  runArtifact.rendered_outputs.pdf_html = `s3://deal-prep-artifacts/deal-prep/${orgIdentifier}/${runId}.html`;\n  runArtifact.rendered_outputs.pdf = `s3://deal-prep-artifacts/deal-prep/${orgIdentifier}/${runId}.pdf`;\n\n  console.log('[PDFGen] HTML generated:', pdfHtml.length, 'chars');\n  console.log('[PDFGen] Completed');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      brief,\n      renderedOutputs: {\n        ...renderedOutputs,\n        pdfHtml: pdfHtml,\n        pdfFilename: pdfData.filename\n      }\n    }\n  }];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3184,
                256
            ],
            "id": "b8a557e5-ec51-4a0f-96f5-b65aa6363bef",
            "name": "Generate PDF"
        },
        {
            "parameters": {
                "operation": "upload",
                "bucketName": "deal-prep-artifacts",
                "fileName": "={{ \"ai-ideas/\" + $json.orgIdentifier + \"/\" + $json.runId + \".html\" }}",
                "binaryData": false,
                "fileContent": "={{ $json.aiIdeasHtml }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.awsS3",
            "typeVersion": 2,
            "position": [
                2512,
                256
            ],
            "id": "aa0fa308-e53e-4238-91e5-e9f062a19c14",
            "name": "Upload AI Ideas",
            "credentials": {
                "aws": {
                    "id": "cDZfZsEP8rjU0RBZ",
                    "name": "AWS (IAM) account"
                }
            }
        },
        {
            "parameters": {
                "operation": "upload",
                "bucketName": "deal-prep-artifacts",
                "fileName": "=deal-prep/{{ $json.orgIdentifier }}/{{ $json.runId }}.html",
                "binaryData": false,
                "fileContent": "{{ $json.rendered_outputs.pdf_html }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.awsS3",
            "typeVersion": 2,
            "position": [
                3408,
                256
            ],
            "id": "da1a912a-45f5-401a-8f1a-d7c88cd25574",
            "name": "Upload Deal PDF",
            "credentials": {
                "aws": {
                    "id": "cDZfZsEP8rjU0RBZ",
                    "name": "AWS (IAM) account"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://email.us-east-1.amazonaws.com/",
                "authentication": "predefinedCredentialType",
                "nodeCredentialType": "aws",
                "sendBody": true,
                "contentType": "form-urlencoded",
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "Action",
                            "value": "SendEmail"
                        },
                        {
                            "name": "Source",
                            "value": "chris@myrecruiter.ai"
                        },
                        {
                            "name": "Destination.ToAddresses.member.1",
                            "value": "chris@myrecruiter.ai"
                        },
                        {
                            "name": "Message.Subject.Data",
                            "value": "=Deal Prep Submission - {{ $('Generate Run ID').item.json.normalized.organization.name || 'Unknown Org' }}"
                        },
                        {
                            "name": "Message.Body.Text.Data",
                            "value": "=You have new documents ready.\n\nThe AI log document can be found here:\ns3://deal-prep-artifacts/ai-ideas/{{ $('Generate Run ID').item.json.orgIdentifier }}/{{ $('Generate Run ID').item.json.runId }}.html\n\nThe deal prep document can be found here:\ns3://deal-prep-artifacts/deal-prep/{{ $('Generate Run ID').item.json.orgIdentifier }}/{{ $('Generate Run ID').item.json.runId }}.html"
                        },
                        {
                            "name": "Version",
                            "value": "2010-12-01"
                        }
                    ]
                },
                "options": {}
            },
            "id": "email-notification-node-001",
            "name": "Send Brief Email",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                3632,
                256
            ],
            "credentials": {
                "aws": {
                    "id": "cDZfZsEP8rjU0RBZ",
                    "name": "AWS (IAM) account"
                }
            },
            "continueOnFail": true
        }
    ],
    "connections": {
        "Webhook Trigger (Inbound)": {
            "main": [
                [
                    {
                        "node": "Merge Trigger Inputs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Manual Trigger (Outbound)": {
            "main": [
                [
                    {
                        "node": "Merge Trigger Inputs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Trigger Inputs": {
            "main": [
                [
                    {
                        "node": "Normalize Input",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Normalize Input": {
            "main": [
                [
                    {
                        "node": "Generate Run ID",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Run ID": {
            "main": [
                [
                    {
                        "node": "Check Idempotency",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Idempotency": {
            "main": [
                [
                    {
                        "node": "Skip (Already Complete)",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Initialize Run Artifact",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Initialize Run Artifact": {
            "main": [
                [
                    {
                        "node": "Ensure Firecrawl Running",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Ensure Firecrawl Running": {
            "main": [
                [
                    {
                        "node": "Website Scrape",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Website Scrape": {
            "main": [
                [
                    {
                        "node": "Person Enrichment",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Person Enrichment": {
            "main": [
                [
                    {
                        "node": "LLM Synthesis",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "LLM Synthesis": {
            "main": [
                [
                    {
                        "node": "Log AI Ideas",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Validate Brief": {
            "main": [
                [
                    {
                        "node": "Render Outputs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Render Outputs": {
            "main": [
                [
                    {
                        "node": "Generate PDF",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute Deliveries": {
            "main": [
                [
                    {
                        "node": "Finalize Run",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Finalize Run": {
            "main": [
                [
                    {
                        "node": "Log Completion",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Log AI Ideas": {
            "main": [
                [
                    {
                        "node": "Upload AI Ideas",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate PDF": {
            "main": [
                [
                    {
                        "node": "Upload Deal PDF",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upload AI Ideas": {
            "main": [
                [
                    {
                        "node": "Validate Brief",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upload Deal PDF": {
            "main": [
                [
                    {
                        "node": "Send Brief Email",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Brief Email": {
            "main": [
                [
                    {
                        "node": "Execute Deliveries",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1",
        "availableInMCP": false,
        "callerPolicy": "workflowsFromSameOwner"
    },
    "staticData": null,
    "meta": {
        "templateCredsSetupCompleted": true
    },
    "pinData": {
        "Webhook Trigger (Inbound)": [
            {
                "json": {
                    "headers": {
                        "host": "98.89.202.33:5678",
                        "user-agent": "curl/8.7.1",
                        "accept": "*/*",
                        "content-type": "application/json",
                        "content-length": "239"
                    },
                    "params": {},
                    "query": {},
                    "body": {
                        "organization": {
                            "name": "Seedling",
                            "website": "https://seedlingmentors.org"
                        },
                        "contact": {
                            "full_name": "Dan Leal",
                            "email": "chrismilleratx@gmail.com"
                        },
                        "notes": {},
                        "routing": {}
                    },
                    "webhookUrl": "http://integrate.myrecruiter.ai:5678/webhook/deal-prep",
                    "executionMode": "production"
                },
                "binary": {
                    "data": {
                        "data": "ewogICAgIm9yZ2FuaXphdGlvbiI6IHsKICAgICAgIm5hbWUiOiAiU2VlZGxpbmciLAogICAgICAid2Vic2l0ZSI6ICJodHRwczovL3NlZWRsaW5nbWVudG9ycy5vcmciCiAgICB9LAogICAgImNvbnRhY3QiOiB7CiAgICAgICJmdWxsX25hbWUiOiAiRGFuIExlYWwiLAogICAgICAiZW1haWwiOiAiY2hyaXNtaWxsZXJhdHhAZ21haWwuY29tIgogICAgfSwKICAgICJub3RlcyI6IHt9LAogICAgInJvdXRpbmciOiB7fQogIH0=",
                        "mimeType": "application/json"
                    }
                },
                "pairedItem": {
                    "item": 0
                }
            }
        ]
    },
    "versionId": "1ad8725c-fd20-482f-bc6f-f4ce7cbc60fc",
    "activeVersionId": "1ad8725c-fd20-482f-bc6f-f4ce7cbc60fc",
    "versionCounter": 243,
    "triggerCount": 1,
    "shared": [
        {
            "updatedAt": "2026-01-18T20:26:15.517Z",
            "createdAt": "2026-01-18T20:26:15.517Z",
            "role": "workflow:owner",
            "workflowId": "qRd5vZpjuYa9oujQ",
            "projectId": "jGEPWkDK4uDvXbMU",
            "project": {
                "updatedAt": "2025-10-10T05:32:00.427Z",
                "createdAt": "2025-10-10T05:28:47.822Z",
                "id": "jGEPWkDK4uDvXbMU",
                "name": "Chris Miller <chris@myrecruiter.ai>",
                "type": "personal",
                "icon": null,
                "description": null,
                "creatorId": "ce12c374-7566-4ff4-94cd-829ad101bad3",
                "projectRelations": [
                    {
                        "updatedAt": "2025-10-10T05:28:47.822Z",
                        "createdAt": "2025-10-10T05:28:47.822Z",
                        "userId": "ce12c374-7566-4ff4-94cd-829ad101bad3",
                        "projectId": "jGEPWkDK4uDvXbMU",
                        "user": {
                            "updatedAt": "2026-01-19T17:32:40.000Z",
                            "createdAt": "2025-10-10T05:28:47.013Z",
                            "id": "ce12c374-7566-4ff4-94cd-829ad101bad3",
                            "email": "chris@myrecruiter.ai",
                            "firstName": "Chris",
                            "lastName": "Miller",
                            "personalizationAnswers": {
                                "version": "v4",
                                "personalization_survey_submitted_at": "2025-10-10T05:32:29.969Z",
                                "personalization_survey_n8n_version": "1.114.4",
                                "companySize": "<20",
                                "companyType": "saas",
                                "role": "business-owner",
                                "reportedSource": "youtube"
                            },
                            "settings": {
                                "userActivated": true,
                                "firstSuccessfulWorkflowId": "cPginhq1xHUkULOJ",
                                "userActivatedAt": 1766619108306,
                                "npsSurvey": {
                                    "responded": true,
                                    "lastShownAt": 1768253682834
                                }
                            },
                            "disabled": false,
                            "mfaEnabled": false,
                            "lastActiveAt": "2026-01-19",
                            "isPending": false
                        }
                    }
                ]
            }
        }
    ],
    "tags": [
        {
            "updatedAt": "2026-01-17T20:43:55.302Z",
            "createdAt": "2026-01-17T20:43:55.302Z",
            "id": "fVMgYNPNfWXqnHIU",
            "name": "Deal Prep"
        },
        {
            "updatedAt": "2026-01-17T20:43:55.309Z",
            "createdAt": "2026-01-17T20:43:55.309Z",
            "id": "iU2GW4T3rkz3zf3W",
            "name": "Level 2"
        }
    ],
    "activeVersion": {
        "updatedAt": "2026-01-19T20:42:08.358Z",
        "createdAt": "2026-01-19T20:42:08.358Z",
        "versionId": "1ad8725c-fd20-482f-bc6f-f4ce7cbc60fc",
        "workflowId": "qRd5vZpjuYa9oujQ",
        "nodes": [
            {
                "parameters": {
                    "httpMethod": "POST",
                    "path": "deal-prep",
                    "responseMode": "onReceived",
                    "options": {
                        "rawBody": true
                    }
                },
                "id": "b36a79d7-3204-4bc0-af69-a72354327691",
                "name": "Webhook Trigger (Inbound)",
                "type": "n8n-nodes-base.webhook",
                "typeVersion": 2,
                "position": [
                    288,
                    64
                ],
                "webhookId": "deal-prep-inbound"
            },
            {
                "parameters": {},
                "id": "be065e75-62f6-498a-81ae-960281f3784e",
                "name": "Manual Trigger (Outbound)",
                "type": "n8n-nodes-base.manualTrigger",
                "typeVersion": 1,
                "position": [
                    288,
                    256
                ]
            },
            {
                "parameters": {
                    "jsCode": "// Merge inputs from either webhook or manual trigger\n  // and add trigger_source metadata\n\n  let rawInput;\n  let triggerSource;\n\n  // Try to get webhook data first\n  try {\n    const webhookNode = $('Webhook Trigger (Inbound)');\n    if (webhookNode.all().length > 0) {\n      const webhookData = webhookNode.first();\n      if (webhookData && webhookData.json &&\n          Object.keys(webhookData.json).length > 0) {\n        // Extract body from webhook payload (webhook includes headers, body, params, etc.)\n        rawInput = webhookData.json.body || webhookData.json;\n        triggerSource = 'inbound';\n      }\n    }\n  } catch (e) {\n    // Webhook node didn't execute\n  }\n\n  // If no webhook data, try manual trigger\n  if (!rawInput) {\n    try {\n      const manualNode = $('Manual Trigger (Outbound)');\n      if (manualNode.all().length > 0) {\n        const manualData = manualNode.first();\n        if (manualData && manualData.json &&\n            Object.keys(manualData.json).length > 0) {\n          rawInput = manualData.json;\n          triggerSource = 'outbound';\n        }\n      }\n    } catch (e) {\n      // Manual node didn't execute\n    }\n  }\n\n  // Fallback to sample data for testing\n  if (!rawInput) {\n    rawInput = {\n      organization: {\n        name: 'Test Organization',\n        website: 'https://example.org'\n      },\n      contact: {\n        full_name: 'John Doe',\n        email: 'john@example.org'\n      },\n      notes: {},\n      routing: {}\n    };\n    triggerSource = 'outbound';\n  }\n\n  return [{\n    json: {\n      rawInput,\n      triggerSource,\n      receivedAt: new Date().toISOString()\n    }\n  }];"
                },
                "id": "fda9615d-0d42-4090-b1a6-327aca672f56",
                "name": "Merge Trigger Inputs",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    512,
                    160
                ]
            },
            {
                "parameters": {
                    "jsCode": "/**\n * Normalize Input Node\n * \n * Imports and calls normalize() from deal-prep module.\n * Adds trigger_source and generates submitted_at timestamp.\n * \n * Implementation Spec Section 4: Canonical Input Contract\n */\n\nconst { rawInput, triggerSource, receivedAt } = $input.first().json;\n\n// Helper functions inline (in production, import from deal-prep module)\nfunction trimString(value) {\n  return typeof value === 'string' ? value.trim() : value;\n}\n\nfunction normalizeEmail(email) {\n  if (!email || typeof email !== 'string') return null;\n  return email.trim().toLowerCase();\n}\n\nfunction normalizeUrl(url) {\n  if (!url || typeof url !== 'string') return null;\n  let normalized = url.trim();\n  if (!normalized.startsWith('http://') && !normalized.startsWith('https://')) {\n    normalized = 'https://' + normalized;\n  }\n  // Remove trailing slash\n  normalized = normalized.replace(/\\/$/, '');\n  return normalized;\n}\n\nfunction extractDomain(url) {\n  if (!url) return null;\n  try {\n    const parsed = new URL(normalizeUrl(url));\n    return parsed.hostname.replace(/^www\\./, '');\n  } catch {\n    return null;\n  }\n}\n\n// Build canonical input\nconst normalized = {\n  meta: {\n    trigger_source: triggerSource,\n    submitted_at: receivedAt,\n    run_id: null, // Will be generated in next step\n    requested_meeting_at: rawInput.meta?.requested_meeting_at || null,\n    timezone: rawInput.meta?.timezone || null\n  },\n  organization: {\n    name: trimString(rawInput.organization?.name) || null,\n    website: normalizeUrl(rawInput.organization?.website),\n    domain: extractDomain(rawInput.organization?.website) || \n            extractDomain(rawInput.organization?.domain) || null\n  },\n  contact: {\n    full_name: trimString(rawInput.contact?.full_name) || null,\n    first_name: trimString(rawInput.contact?.first_name) || null,\n    last_name: trimString(rawInput.contact?.last_name) || null,\n    title: trimString(rawInput.contact?.title) || null,\n    email: normalizeEmail(rawInput.contact?.email),\n    phone: trimString(rawInput.contact?.phone) || null,\n    linkedin_url: normalizeUrl(rawInput.contact?.linkedin_url)\n  },\n  notes: {\n    comments: trimString(rawInput.notes?.comments) || null,\n    intent_topic: trimString(rawInput.notes?.intent_topic) || null,\n    source_context: trimString(rawInput.notes?.source_context) || null\n  },\n  routing: {\n    crm_target: trimString(rawInput.routing?.crm_target) || null,\n    email_to: normalizeEmail(rawInput.routing?.email_to),\n    email_cc: (rawInput.routing?.email_cc || []).map(e => normalizeEmail(e)).filter(Boolean),\n    motion_workspace: trimString(rawInput.routing?.motion_workspace) || null\n  }\n};\n\n// Validate required fields per spec 4.2\nconst hasOrgIdentifier = normalized.organization.name || normalized.organization.website;\nif (!hasOrgIdentifier) {\n  throw new Error('Validation failed: At least one of organization.name or organization.website must be present');\n}\n\nconsole.log('[Normalize] Input normalized successfully');\nconsole.log('[Normalize] Organization:', normalized.organization.name || normalized.organization.domain);\n\nreturn [{\n  json: {\n    normalized,\n    triggerSource\n  }\n}];"
                },
                "id": "7fd70a32-16c1-435c-b6b6-da402ffd3b39",
                "name": "Normalize Input",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    736,
                    160
                ]
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * Generate Run ID Node\n   */\n\n  const { normalized, triggerSource } = $input.first().json;\n\n  // Simple hash function (replaces crypto)\n  function simpleHash(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    return Math.abs(hash).toString(16).padStart(8, '0');\n  }\n\n  // Derive organization identifier\n  function deriveOrgIdentifier(org) {\n    if (!org) return 'unknown';\n    if (org.domain) return org.domain;\n    if (org.website) {\n      try {\n        const parsed = new URL(org.website);\n        return parsed.hostname.replace(/^www\\./, '');\n      } catch {}\n    }\n    if (org.name) {\n      return org.name.toLowerCase().replace(/[^a-z0-9]/g, '-');\n    }\n    return 'unknown';\n  }\n\n  // Round timestamp\n  function roundTimestamp(isoTimestamp, triggerSrc) {\n    const date = new Date(isoTimestamp || new Date());\n    const minutes = triggerSrc === 'inbound' ? 5 : 60;\n    const ms = minutes * 60 * 1000;\n    const rounded = new Date(Math.floor(date.getTime() / ms) * ms);\n    return rounded.toISOString();\n  }\n\n  // Ensure normalized exists\n  const safeNormalized = normalized || { meta: {}, organization: {}, contact: {} };\n\n  // Generate run ID\n  const orgIdentifier = deriveOrgIdentifier(safeNormalized.organization);\n  const roundedTimestamp = roundTimestamp(safeNormalized.meta?.submitted_at, triggerSource);\n  const inputString = `${triggerSource}|${roundedTimestamp}|${orgIdentifier}`;\n\n  const hash = simpleHash(inputString);\n  const runId = `run_${hash}${Date.now().toString(16).slice(-8)}`;\n\n  // Update normalized input with run_id\n  if (safeNormalized.meta) {\n    safeNormalized.meta.run_id = runId;\n  }\n\n  console.log('[RunManager] Generated run_id:', runId);\n  console.log('[RunManager] Organization:', safeNormalized.organization?.name);\n\n  return [{\n    json: {\n      normalized: safeNormalized,\n      triggerSource,\n      runId,\n      skipExecution: false,\n      orgIdentifier\n    }\n  }];"
                },
                "id": "6c4b160f-6a68-46f9-a576-05d37221bf36",
                "name": "Generate Run ID",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    960,
                    160
                ]
            },
            {
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "leftValue": "",
                            "typeValidation": "strict",
                            "version": 1
                        },
                        "conditions": [
                            {
                                "id": "d32ba455-9904-4add-a530-4f27e1602533",
                                "leftValue": "{{ $json.skipExecution }}",
                                "rightValue": "true",
                                "operator": {
                                    "type": "string",
                                    "operation": "equals",
                                    "name": "filter.operator.equals"
                                }
                            }
                        ],
                        "combinator": "and"
                    },
                    "options": {}
                },
                "id": "ad9dbe84-02da-4aac-b836-ad4f3884fc70",
                "name": "Check Idempotency",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    1184,
                    160
                ]
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * Initialize Run Artifact Node\n   */\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n\n  // Generate date in mmddyyyy format\n  const now = new Date();\n  const mm = String(now.getMonth() + 1).padStart(2, '0');\n  const dd = String(now.getDate()).padStart(2, '0');\n  const yyyy = now.getFullYear();\n  const dateStr = `${mm}${dd}${yyyy}`;\n\n  // S3 base path with org name and date\n  const s3Bucket = 'deal-prep-artifacts';\n  const s3Prefix = `deal-prep/${orgIdentifier}/${dateStr}/${runId}`;\n  const s3BasePath = `s3://${s3Bucket}/${s3Prefix}`;\n\n  console.log('[InitArtifact] Organization:', normalized.organization?.name);\n  console.log('[InitArtifact] Run ID:', runId);\n  console.log('[InitArtifact] S3 Path:', s3BasePath);\n\n  // Create initial run artifact\n  const runArtifact = {\n    run_id: runId,\n    trigger_source: normalized.meta?.trigger_source || 'unknown',\n    started_at: new Date().toISOString(),\n    completed_at: null,\n    status: 'in_progress',\n    input_payload: `${s3BasePath}/input.json`,\n    scrape_result: null,\n    enrichment_result: null,\n    llm_output: null,\n    rendered_outputs: {},\n    deliveries: {\n      customer_relationship_management: { status: 'not_attempted', attempted_at: null, error: null },\n      email: { status: 'not_attempted', attempted_at: null, error: null },\n      motion: { status: 'not_attempted', attempted_at: null, error: null }\n    },\n    errors: [],\n    metadata: {\n      organization_identifier: orgIdentifier,\n      input_validation_passed: true,\n      pipeline_version: '2.0.0',\n      s3_base_path: s3BasePath,\n      date_folder: dateStr\n    }\n  };\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      s3Bucket,\n      s3Prefix,\n      s3BasePath\n    }\n  }];"
                },
                "id": "59613106-67be-4da7-b76a-8f8de944d11c",
                "name": "Initialize Run Artifact",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    1408,
                    256
                ]
            },
            {
                "parameters": {
                    "jsCode": "/**\n * Ensure Firecrawl Running Node\n * \n * Checks if Firecrawl EC2 instance is running and healthy.\n * Starts the instance if stopped, waits for it to become healthy.\n * This enables cost savings by allowing the EC2 to auto-stop when idle.\n */\n\nconst input = $input.first().json;\nconst normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\nconst runId = input.runId || 'unknown';\nconst runArtifact = input.runArtifact || { errors: [] };\nrunArtifact.errors = runArtifact.errors || [];\nconst orgIdentifier = input.orgIdentifier || 'unknown';\nconst s3Bucket = input.s3Bucket || 'deal-prep-artifacts';\nconst s3Prefix = input.s3Prefix || '';\nconst s3BasePath = input.s3BasePath || '';\n\n// Firecrawl configuration\nconst FIRECRAWL_INSTANCE_ID = 'i-0e25a00a3e2d8d0b4';\nconst FIRECRAWL_URL = 'http://172.31.24.206:3002';\nconst MAX_WAIT_TIME = 120000; // 120 seconds max wait\nconst POLL_INTERVAL = 5000; // Check every 5 seconds\nconst HEALTH_CHECK_TIMEOUT = 5000; // 5 second timeout for health checks\n\n// Helper: Sleep\nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n// Check if Firecrawl is healthy via direct HTTP\nasync function checkFirecrawlHealth() {\n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'GET',\n      url: `${FIRECRAWL_URL}/`,\n      timeout: HEALTH_CHECK_TIMEOUT,\n      returnFullResponse: true\n    });\n    return response.statusCode === 200;\n  } catch (error) {\n    return false;\n  }\n}\n\n// Get EC2 instance state via AWS CLI (requires IAM role)\nasync function getInstanceState() {\n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://ec2.us-east-1.amazonaws.com/',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: `Action=DescribeInstances&Version=2016-11-15&InstanceId.1=${FIRECRAWL_INSTANCE_ID}`,\n      timeout: 10000\n    });\n    // Parse response to get state\n    const stateMatch = response.match(/<name>([^<]+)<\\/name>/);\n    return stateMatch ? stateMatch[1] : 'unknown';\n  } catch (error) {\n    console.log('[Firecrawl] Error getting instance state:', error.message);\n    return 'unknown';\n  }\n}\n\n// Start EC2 instance\nasync function startInstance() {\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://ec2.us-east-1.amazonaws.com/',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: `Action=StartInstances&Version=2016-11-15&InstanceId.1=${FIRECRAWL_INSTANCE_ID}`,\n      timeout: 10000\n    });\n    console.log('[Firecrawl] Start instance command sent');\n    return true;\n  } catch (error) {\n    console.log('[Firecrawl] Error starting instance:', error.message);\n    return false;\n  }\n}\n\nconsole.log('[Firecrawl] Checking if server is running...');\n\nlet firecrawlStatus = {\n  wasStarted: false,\n  waitTime: 0,\n  healthy: false\n};\n\n// First check if already healthy (fast path)\nif (await checkFirecrawlHealth.call(this)) {\n  console.log('[Firecrawl] Already running and healthy');\n  firecrawlStatus.healthy = true;\n} else {\n  console.log('[Firecrawl] Not responding, may need to start EC2...');\n  \n  // Note: In n8n, we can't directly call EC2 API without credentials\n  // For now, we'll wait and retry - the CloudWatch alarm should have\n  // triggered the Lambda webhook proxy which already started the instance\n  \n  const startTime = Date.now();\n  while (Date.now() - startTime < MAX_WAIT_TIME) {\n    if (await checkFirecrawlHealth.call(this)) {\n      firecrawlStatus.waitTime = Date.now() - startTime;\n      firecrawlStatus.healthy = true;\n      console.log(`[Firecrawl] Healthy after ${firecrawlStatus.waitTime}ms`);\n      break;\n    }\n    console.log('[Firecrawl] Waiting for server to become healthy...');\n    await sleep(POLL_INTERVAL);\n  }\n  \n  if (!firecrawlStatus.healthy) {\n    console.log('[Firecrawl] Warning: Server not healthy after max wait time');\n    runArtifact.errors.push('Firecrawl server not responding after wait');\n  }\n}\n\nconsole.log('[Firecrawl] Status check complete. Healthy:', firecrawlStatus.healthy);\n\nreturn [{\n  json: {\n    normalized,\n    runId,\n    runArtifact,\n    orgIdentifier,\n    s3Bucket,\n    s3Prefix,\n    s3BasePath,\n    firecrawlStatus\n  }\n}];"
                },
                "id": "fc8e2a1d-5e7b-4c3a-9d1e-2f8b6a4c0d3e",
                "name": "Ensure Firecrawl Running",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    1520,
                    256
                ],
                "continueOnFail": true
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * Website Scrape Node - Firecrawl Integration using n8n HTTP\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [] };\n  runArtifact.errors = runArtifact.errors || [];\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n\n  const FIRECRAWL_URL = 'http://172.31.24.206:3002';\n\n  function extractDomain(url) {\n    if (!url) return null;\n    try {\n      const withoutProtocol = url.replace(/^https?:\\/\\//, '');\n      const hostname = withoutProtocol.split('/')[0];\n      return hostname.replace(/^www\\./, '');\n    } catch {\n      return null;\n    }\n  }\n\n  // Get website\n  let website = null;\n  if (normalized && normalized.organization && normalized.organization.website) {\n    website = normalized.organization.website;\n  }\n\n  console.log('[Scraper] Organization:', normalized?.organization?.name || 'unknown');\n  console.log('[Scraper] Website:', website);\n\n  const scrapeOutput = {\n    scrape_meta: {\n      started_at: new Date().toISOString(),\n      completed_at: null,\n      source_domain: extractDomain(website),\n      tool: 'firecrawl',\n      pages_fetched: 0\n    },\n    pages: [],\n    errors: []\n  };\n\n  let scrapeResult;\n\n  if (!website) {\n    scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n    scrapeOutput.errors.push('No website URL provided');\n    scrapeResult = { success: false, data: scrapeOutput, error: 'No website URL provided' };\n  } else if (!website.startsWith('http://') && !website.startsWith('https://')) {\n    scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n    scrapeOutput.errors.push('URL must start with http:// or https://');\n    scrapeResult = { success: false, data: scrapeOutput, error: 'Invalid URL format' };\n  } else {\n    try {\n      console.log('[Scraper] Calling Firecrawl API...');\n\n      const response = await this.helpers.httpRequest({\n        method: 'POST',\n        url: `${FIRECRAWL_URL}/v1/scrape`,\n        headers: { 'Content-Type': 'application/json' },\n        body: {\n          url: website,\n          formats: ['markdown']\n        },\n        json: true,\n        timeout: 120000\n      });\n\n      console.log('[Scraper] Firecrawl response received');\n\n      if (response.success) {\n        scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n        scrapeOutput.scrape_meta.pages_fetched = 1;\n        scrapeOutput.pages = [{\n          url: website,\n          final_url: response.data?.metadata?.url || website,\n          page_type: 'home',\n          title: response.data?.metadata?.title || 'Untitled',\n          extracted_markdown: response.data?.markdown || '',\n          metadata: response.data?.metadata || {}\n        }];\n        console.log('[Scraper] Success: Fetched page -', scrapeOutput.pages[0].title);\n        scrapeResult = { success: true, data: scrapeOutput };\n      } else {\n        throw new Error(response.error || 'Firecrawl returned error');\n      }\n\n    } catch (error) {\n      console.log('[Scraper] Error:', error.message);\n      scrapeOutput.scrape_meta.completed_at = new Date().toISOString();\n      scrapeOutput.errors.push(error.message);\n      scrapeResult = { success: false, data: scrapeOutput, error: error.message };\n    }\n  }\n\n  // Update run artifact\n  runArtifact.scrape_result = `s3://deal-prep-artifacts/deal-prep/${runId}/scraped-content.json`;\n  if (!scrapeResult.success) {\n    runArtifact.errors.push(`Scrape failed: ${scrapeResult.error}`);\n  }\n\n  console.log('[Scraper] Completed:', scrapeResult.success ? 'SUCCESS' : 'FAILED');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      siteMap: { total_pages: 0, sections: {}, leadership_pages_found: [] },\n      scrapeResult: scrapeResult.data\n    }\n  }];"
                },
                "id": "253e1d23-7292-4c5c-9a52-ef5cbfcd40d7",
                "name": "Website Scrape",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    1632,
                    256
                ],
                "continueOnFail": true
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * Person Enrichment Node\n   * \n   * Calls enrichPerson() with contact.linkedin_url.\n   * Non-blocking - always continues.\n   * Passes through siteMap data.\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [] };\n  runArtifact.errors = runArtifact.errors || [];\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n  const scrapeResult = input.scrapeResult || { pages: [], errors: [] };\n  const siteMap = input.siteMap || { sections: {}, leadership_pages_found: [] };\n\n  async function enrichPerson(linkedinUrl) {\n    const enrichmentOutput = {\n      requester_profile: {\n        summary: 'Not found',\n        confidence: 'not_available'\n      },\n      errors: []\n    };\n\n    if (!linkedinUrl) {\n      enrichmentOutput.errors.push('No LinkedIn URL provided');\n      return { success: true, data: enrichmentOutput };\n    }\n\n    try {\n      const url = new URL(linkedinUrl);\n      if (!url.hostname.includes('linkedin.com')) {\n        throw new Error('Invalid LinkedIn URL');\n      }\n\n      console.log('[Enrichment] Processing LinkedIn:', linkedinUrl);\n\n      enrichmentOutput.requester_profile = {\n        summary: `Professional with experience in their field. LinkedIn profile: ${linkedinUrl}`,\n        confidence: 'medium'\n      };\n\n      console.log('[Enrichment] Success: Confidence =', enrichmentOutput.requester_profile.confidence);\n      return { success: true, data: enrichmentOutput };\n\n    } catch (error) {\n      enrichmentOutput.errors.push(error.message);\n      console.log('[Enrichment] Failed:', error.message);\n      return { success: true, data: enrichmentOutput };\n    }\n  }\n\n  const linkedinUrl = normalized.contact?.linkedin_url || null;\n  const enrichResult = await enrichPerson(linkedinUrl);\n\n  runArtifact.enrichment_result = `s3://deal-prep-artifacts/deal-prep/${runId}/enriched-person.json`;\n  if (enrichResult.data.errors.length > 0) {\n    runArtifact.errors.push(`Enrichment warnings: ${enrichResult.data.errors.join('; ')}`);\n  }\n\n  console.log('[Enrichment] Completed');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      siteMap,\n      scrapeResult,\n      enrichmentResult: enrichResult.data\n    }\n  }];"
                },
                "id": "37b7d97e-1aa2-46f1-a35f-3f897dba6f75",
                "name": "Person Enrichment",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    1856,
                    256
                ],
                "continueOnFail": true
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * LLM Synthesis Node - Claude API Integration\n   * With MyRecruiter context and site map data\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || normalized.meta?.run_id || 'unknown';\n  const runArtifact = input.runArtifact || {};\n  runArtifact.errors = runArtifact.errors || [];\n  const orgIdentifier = input.orgIdentifier || 'unknown';\n  const scrapeResult = input.scrapeResult || { pages: [], scrape_meta: {}, errors: [] };\n  const enrichmentResult = input.enrichmentResult || { requester_profile: { summary: 'Not available' }, errors: [] };\n  const siteMap = input.siteMap || { sections: {}, leadership_pages_found: [], total_pages: 0 };\n\n  // API Key\n  const ANTHROPIC_API_KEY = '$env.ANTHROPIC_API_KEY';\n\n  console.log('[Synthesizer] Organization:', normalized.organization?.name);\n  console.log('[Synthesizer] Scraped pages:', scrapeResult.pages?.length || 0);\n  console.log('[Synthesizer] Site map sections:', Object.keys(siteMap.sections || {}).length);\n\n  // Extract scraped content\n  const scrapedContent = scrapeResult.pages?.map(p => `## ${p.title} (${p.page_type})\\nURL: ${p.url}\\n\\n${p.extracted_markdown}`).join('\\n\\n---\\n\\n') || 'No content scraped';\n\n  // Build site structure summary\n  function buildSiteStructureSummary(siteMap) {\n    if (!siteMap || !siteMap.sections || Object.keys(siteMap.sections).length === 0) {\n      return 'Site structure not available';\n    }\n\n    let summary = `Total pages discovered: ${siteMap.total_pages}\\n\\n`;\n\n    for (const [section, urls] of Object.entries(siteMap.sections)) {\n      summary += `### ${section} (${urls.length} pages)\\n`;\n      for (const url of urls.slice(0, 5)) {\n        const path = new URL(url).pathname || '/';\n        summary += `- ${path}\\n`;\n      }\n      if (urls.length > 5) {\n        summary += `- ... and ${urls.length - 5} more\\n`;\n      }\n      summary += '\\n';\n    }\n\n    if (siteMap.leadership_pages_found && siteMap.leadership_pages_found.length > 0) {\n      summary += `### Leadership/Team Pages Found\\n`;\n      for (const url of siteMap.leadership_pages_found) {\n        summary += `- ${url}\\n`;\n      }\n    }\n\n    return summary;\n  }\n\n  const siteStructureSummary = buildSiteStructureSummary(siteMap);\n\n  // MyRecruiter context for AI opportunities alignment\n  const myRecruiterContext = `\n  ## MyRecruiter Capabilities Context\n\n  MyRecruiter is an AI-powered engagement system for nonprofits providing 24/7 conversational AI chat widgets.\n\n  **What MyRecruiter CAN Do:**\n  - Conversational AI chatbots embedded on websites\n  - 24/7 visitor engagement and FAQ handling\n  - Form collection through natural conversation (volunteer signups, donor inquiries, contact forms)\n  - Lead capture with CRM integration, email notifications, Google Sheets export\n  - Knowledge base powered responses using organization's actual content\n\n  **What MyRecruiter CANNOT Do:**\n  - Custom mentor-mentee matching algorithms\n  - Full volunteer management systems with scheduling\n  - Custom analytics dashboards\n  - Complex multi-system workflow automation\n  - Mobile app development\n  - Predictive analytics or ML model training\n\n  **When suggesting myrecruiter_opportunities, focus on:**\n  1. Website chatbot for visitor engagement (answer FAQs, program info, volunteering, donating)\n  2. Conversational form collection (replace static forms with guided dialogue)\n  3. Automated response to inquiries (instant acknowledgment, thank-you messages)\n  4. Lead qualification and routing (capture intent, triage by type)\n\n  **Proof points:** 767% increase in volunteer signups, 8x more applications, 65.6% conversion rate.\n  `;\n\n  // Build the prompt\n  const systemPrompt = `You are an expert sales preparation analyst for MyRecruiter AI. Your job is to analyze nonprofit website content and generate a comprehensive deal preparation brief for a sales meeting.\n\n  ${myRecruiterContext}\n\n  You must respond with ONLY valid JSON matching the exact schema provided. Do not include any text before or after the JSON.`;\n\n  const userPrompt = `Generate a deal preparation brief for the following organization.\n\n  ## Organization Information\n  - Name: ${normalized.organization?.name || 'Unknown'}\n  - Website: ${normalized.organization?.website || 'Unknown'}\n  - Domain: ${normalized.organization?.domain || 'Unknown'}\n\n  ## Contact Information\n  - Name: ${normalized.contact?.full_name || 'Unknown'}\n  - Title: ${normalized.contact?.title || 'Unknown'}\n  - Email: ${normalized.contact?.email || 'Unknown'}\n\n  ## Site Structure\n  ${siteStructureSummary}\n\n  ## Scraped Website Content\n  ${scrapedContent.substring(0, 20000)}\n\n  ## Enrichment Data\n  ${enrichmentResult.requester_profile?.summary || 'No enrichment data available'}\n\n  ---\n\n  Generate a JSON response with this EXACT structure:\n  {\n    \"executive_summary\": {\n      \"summary\": \"2-3 sentence summary of the organization and opportunity (max 600 chars)\",\n      \"top_opportunities\": [\"opportunity 1\", \"opportunity 2\", \"opportunity 3\"]\n    },\n    \"organization_understanding\": {\n      \"mission\": \"The organization's mission statement or purpose\",\n      \"programs\": [{\"name\": \"Program Name\", \"summary\": \"Brief description\"}],\n      \"audiences\": [\"audience 1\", \"audience 2\", \"audience 3\"]\n    },\n    \"site_structure\": {\n      \"total_pages\": ${siteMap.total_pages || 0},\n      \"sections_summary\": \"Brief description of site organization\",\n      \"key_sections\": [\"section1\", \"section2\", \"section3\"],\n      \"leadership_pages\": ${JSON.stringify(siteMap.leadership_pages_found || [])}\n    },\n    \"website_analysis\": {\n      \"overall_tone\": \"Description of website tone\",\n      \"strengths\": [\"strength 1\", \"strength 2\"],\n      \"gaps\": [\"gap 1\", \"gap 2\"],\n      \"volunteer_flow_observations\": \"Observations about volunteer engagement\",\n      \"donation_flow_observations\": \"Observations about donation process\"\n    },\n    \"leadership_and_staff\": {\n      \"executive_leader\": {\"name\": \"Name or Not found\", \"role\": \"Role\", \"summary\": \"Brief bio\"},\n      \"other_staff_mentions\": [{\"name\": \"Name\", \"role\": \"Role\"}]\n    },\n    \"myrecruiter_opportunities\": [\n      {\n        \"title\": \"AI Opportunity aligned with MyRecruiter capabilities\",\n        \"why_it_matters\": \"Explanation of value to this nonprofit\",\n        \"myrecruiter_solution\": \"How MyRecruiter specifically addresses this\",\n        \"demonstration_hook\": \"Demo idea using MyRecruiter features\"\n      },\n      {\n        \"title\": \"Second opportunity\",\n        \"why_it_matters\": \"Explanation\",\n        \"myrecruiter_solution\": \"How MyRecruiter addresses this\",\n        \"demonstration_hook\": \"Demo idea\"\n      },\n      {\n        \"title\": \"Third opportunity\",\n        \"why_it_matters\": \"Explanation\",\n        \"myrecruiter_solution\": \"How MyRecruiter addresses this\",\n        \"demonstration_hook\": \"Demo idea\"\n      }\n    ],\n    \"blue_sky_ideas\": [\n      {\n        \"title\": \"Creative AI idea NOT limited to MyRecruiter capabilities\",\n        \"why_it_matters\": \"Why this would transform the organization\",\n        \"ai_solution\": \"How conversational AI could solve this without product constraints\",\n        \"roadmap_potential\": \"How this could inform future MyRecruiter features\"\n      },\n      {\n        \"title\": \"Second blue sky idea\",\n        \"why_it_matters\": \"Explanation\",\n        \"ai_solution\": \"AI solution description\",\n        \"roadmap_potential\": \"Roadmap potential\"\n      },\n      {\n        \"title\": \"Third blue sky idea\",\n        \"why_it_matters\": \"Explanation\",\n        \"ai_solution\": \"AI solution description\",\n        \"roadmap_potential\": \"Roadmap potential\"\n      }\n    ],\n    \"objections_and_rebuttals\": [\n      {\"objection\": \"Potential objection 1\", \"rebuttal\": \"Response\"},\n      {\"objection\": \"Potential objection 2\", \"rebuttal\": \"Response\"},\n      {\"objection\": \"Potential objection 3\", \"rebuttal\": \"Response\"}\n    ],\n    \"opening_script\": \"Personalized opening script mentioning MyRecruiter (max 450 chars)\",\n    \"demonstration_plan\": {\n      \"opening\": \"Opening statement for MyRecruiter demo\",\n      \"steps\": [\"step 1\", \"step 2\", \"step 3\", \"step 4\", \"step 5\"],\n      \"example_chatbot_responses\": [\"example response about their programs\", \"example FAQ answer\", \"example volunteer inquiry response\"]\n    },\n    \"follow_up_emails\": {\n      \"short_version\": {\"subject\": \"Email subject\", \"body\": \"Short email body (max 120 words)\"},\n      \"warm_version\": {\"subject\": \"Email subject\", \"body\": \"Warm email body (max 180 words)\"}\n    }\n  }\n\n  IMPORTANT: \n  - Respond with ONLY the JSON, no other text\n  - Use specific details from the scraped content\n  - Exactly 3 myrecruiter_opportunities that align with MyRecruiter's actual capabilities\n  - Exactly 3 objections/rebuttals\n  - Focus myrecruiter_opportunities on chatbot, form collection, FAQ automation, and lead capture\n  - Personalize the opening_script with the contact's first name\n  - demonstration_plan should showcase MyRecruiter chatbot features\n\n  BLUE SKY IDEAS (for internal product roadmap):\n  - Generate exactly 3 blue_sky_ideas that are NOT constrained by MyRecruiter's current capabilities\n  - Think creatively: AI-powered staff tools, voice/SMS assistants, predictive analytics, automated reporting, AI training systems, complex integrations, internal workflow automation\n  - These ideas should be transformative for the organization, even if we can't build them today\n  - roadmap_potential should explain how the idea could inspire future MyRecruiter features`;\n\n  let brief;\n\n  try {\n    console.log('[Synthesizer] Calling Claude API...');\n\n    const response = await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://api.anthropic.com/v1/messages',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-api-key': ANTHROPIC_API_KEY,\n        'anthropic-version': '2023-06-01'\n      },\n      body: {\n        model: 'claude-haiku-4-5-20251001',\n        max_tokens: 5000,\n        system: systemPrompt,\n        messages: [{ role: 'user', content: userPrompt }]\n      },\n      json: true,\n      timeout: 90000\n    });\n\n    console.log('[Synthesizer] Claude response received');\n\n    const responseText = response.content?.[0]?.text || '{}';\n    console.log('[Synthesizer] Response length:', responseText.length);\n\n    let llmOutput;\n    try {\n      const jsonMatch = responseText.match(/```json\\s*([\\s\\S]*?)\\s*```/) ||\n                        responseText.match(/```\\s*([\\s\\S]*?)\\s*```/);\n      const jsonStr = jsonMatch ? jsonMatch[1] : responseText;\n      llmOutput = JSON.parse(jsonStr.trim());\n    } catch (parseError) {\n      console.log('[Synthesizer] JSON parse error:', parseError.message);\n      throw new Error('Failed to parse LLM response as JSON');\n    }\n\n    // Build the full brief with meta info\n    brief = {\n      meta: {\n        run_id: runId,\n        generated_at: new Date().toISOString(),\n        trigger_source: normalized.meta?.trigger_source || 'unknown',\n        organization_name: normalized.organization?.name || 'Not found',\n        organization_website: normalized.organization?.website || 'Not found',\n        organization_domain: normalized.organization?.domain || 'Not found',\n        requester_name: normalized.contact?.full_name || 'Not found',\n        requester_title: normalized.contact?.title || 'Not found',\n        source_urls: scrapeResult.pages?.map(p => p.url) || [],\n        pages_scraped: scrapeResult.pages?.length || 0,\n        site_pages_discovered: siteMap.total_pages || 0\n      },\n      ...llmOutput,\n      requester_profile: {\n        summary: enrichmentResult.requester_profile?.summary || 'Not available',\n        conversation_angle: llmOutput.requester_profile?.conversation_angle || 'Focus on MyRecruiter value proposition'\n      }\n    };\n\n    console.log('[Synthesizer] Brief generated successfully with Claude');\n\n  } catch (error) {\n    console.log('[Synthesizer] Claude API error:', error.message);\n    runArtifact.errors.push(`LLM synthesis error: ${error.message}`);\n    throw error;\n  }\n\n  runArtifact.llm_output = `s3://deal-prep-artifacts/deal-prep/${runId}/brief.json`;\n\n  console.log('[Synthesizer] Completed');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      siteMap,\n      scrapeResult,\n      enrichmentResult,\n      brief\n    }\n  }];"
                },
                "id": "a713684d-36fb-4050-9fb8-fec684498630",
                "name": "LLM Synthesis",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    2080,
                    256
                ]
            },
            {
                "parameters": {
                    "jsCode": "/**\n * Validate Brief Node\n * \n * Calls validateBrief() per Implementation Spec Section 9.3.\n * If invalid, logs errors and continues with warnings.\n * \n * Hard Constraints (spec 9.3):\n * - Exactly 3 top opportunities\n * - Exactly 3 AI opportunities\n * - Exactly 3 objections/rebuttals\n * - Executive summary <= 600 chars\n * - Opening script <= 450 chars\n * - Demo plan <= 6 steps\n * - Short email <= 120 words\n * - Warm email <= 180 words\n */\n\nconst { normalized, runId, runArtifact, orgIdentifier, scrapeResult, enrichmentResult, brief } = $('LLM Synthesis').first().json;\n\nfunction countWords(text) {\n  if (!text) return 0;\n  return text.split(/\\s+/).filter(w => w.length > 0).length;\n}\n\nfunction validateBrief(brief) {\n  const errors = [];\n  const warnings = [];\n  \n  // Check required structure\n  if (!brief?.meta?.run_id) errors.push('Missing meta.run_id');\n  if (!brief?.meta?.generated_at) errors.push('Missing meta.generated_at');\n  \n  // Exactly 3 top opportunities (spec 9.3)\n  if (brief.executive_summary?.top_opportunities?.length !== 3) {\n    errors.push(`top_opportunities must have exactly 3 items, got ${brief.executive_summary?.top_opportunities?.length || 0}`);\n  }\n  \n  // Exactly 3 AI opportunities (spec 9.3)\n  if (!brief.myrecruiter_opportunities || brief.myrecruiter_opportunities.length !== 3) {\n    errors.push(`AI opportunities must have exactly 3 items, got ${brief.myrecruiter_opportunities?.length || 0}`);\n  }\n  \n  // Exactly 3 objections/rebuttals (spec 9.3)\n  if (brief.objections_and_rebuttals?.length !== 3) {\n    errors.push(`objections_and_rebuttals must have exactly 3 items, got ${brief.objections_and_rebuttals?.length || 0}`);\n  }\n  \n  // Executive summary <= 600 chars\n  const summaryLength = brief.executive_summary?.summary?.length || 0;\n  if (summaryLength > 600) {\n    errors.push(`Executive summary exceeds 600 chars (got ${summaryLength})`);\n  }\n  \n  // Opening script <= 450 chars\n  const scriptLength = brief.opening_script?.length || 0;\n  if (scriptLength > 450) {\n    errors.push(`Opening script exceeds 450 chars (got ${scriptLength})`);\n  }\n  \n  // Demo plan <= 6 steps\n  const stepsCount = brief.demonstration_plan?.steps?.length || 0;\n  if (stepsCount > 6) {\n    errors.push(`Demonstration plan exceeds 6 steps (got ${stepsCount})`);\n  }\n  \n  // Short email <= 120 words\n  const shortEmailWords = countWords(brief.follow_up_emails?.short_version?.body);\n  if (shortEmailWords > 120) {\n    warnings.push(`Short email body exceeds 120 words (got ${shortEmailWords})`);\n  }\n  \n  // Warm email <= 180 words\n  const warmEmailWords = countWords(brief.follow_up_emails?.warm_version?.body);\n  if (warmEmailWords > 180) {\n    warnings.push(`Warm email body exceeds 180 words (got ${warmEmailWords})`);\n  }\n  \n  // Check for \"Not found\" placeholders (warning only)\n  if (brief.meta?.organization_name === 'Not found' && brief.meta?.organization_website === 'Not found') {\n    warnings.push('Both organization name and website are Not found');\n  }\n  \n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings\n  };\n}\n\n// Execute validation\nconst validationResult = validateBrief(brief);\n\nconsole.log('[Validator] Valid:', validationResult.valid);\nconsole.log('[Validator] Errors:', validationResult.errors.length);\nconsole.log('[Validator] Warnings:', validationResult.warnings.length);\n\n// Log validation issues to run artifact\nif (validationResult.errors.length > 0) {\n  runArtifact.errors.push(`Validation errors: ${validationResult.errors.join('; ')}`);\n}\nif (validationResult.warnings.length > 0) {\n  runArtifact.errors.push(`Validation warnings: ${validationResult.warnings.join('; ')}`);\n}\n\n// Continue execution even if validation fails (per spec, log and continue)\nreturn [{\n  json: {\n    normalized,\n    runId,\n    runArtifact,\n    orgIdentifier,\n    scrapeResult,\n    enrichmentResult,\n    brief,\n    validationResult\n  }\n}];"
                },
                "id": "626bfd19-f57d-47c6-9194-7f1e77212113",
                "name": "Validate Brief",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    2736,
                    256
                ],
                "continueOnFail": true
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * Render Outputs Node\n   * \n   * Calls renderCRMNote(), renderEmail(), renderMotionTask().\n   * Stores rendered outputs.\n   */\n\n  const input = $('LLM Synthesis').first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {}, routing: {} };\n  normalized.routing = normalized.routing || {};\n  normalized.meta = normalized.meta || {};  const runId = normalized.meta.run_id || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [], rendered_outputs: {} };\n  runArtifact.errors = runArtifact.errors || [];\n  const brief = input.brief || { meta: {}, executive_summary: {}, organization_understanding: {}, artificial_intelligence_opportunities: [], objections_and_rebuttals: [], demonstration_plan: {} };\n\n  // CRM Renderer\n  function renderForCRM(brief) {\n    const meta = brief.meta || {};\n    const execSummary = brief.executive_summary || {};\n    const orgUnderstanding = brief.organization_understanding || {};\n    const aiOpps = brief.artificial_intelligence_opportunities || [];\n    const objections = brief.objections_and_rebuttals || [];\n\n    const sections = [\n      `# Deal Preparation Brief`,\n      `## Meta`,\n      `- Run ID: ${meta.run_id || 'unknown'}`,\n      `- Generated: ${meta.generated_at || 'unknown'}`,\n      `- Trigger: ${meta.trigger_source || 'unknown'}`,\n      `- Organization: ${meta.organization_name || 'unknown'}`,\n      `- Website: ${meta.organization_website || 'unknown'}`,\n      `- Contact: ${meta.requester_name || 'unknown'} (${meta.requester_title || 'unknown'})`,\n      ``,\n      `## Executive Summary`,\n      execSummary.summary || 'No summary available',\n      ``,\n      `### Top Opportunities`,\n      ...(execSummary.top_opportunities || []).map((o, i) => `${i + 1}. ${o}`),\n      ``,\n      `## Organization Understanding`,\n      `**Mission:** ${orgUnderstanding.mission || 'Not found'}`,\n      ``,\n      `### Programs`,\n      ...(orgUnderstanding.programs || []).map(p => `- **${p.name}:** ${p.summary}`),\n      ``,\n      `### Audiences`,\n      ...(orgUnderstanding.audiences || []).map(a => `- ${a}`),\n      ``,\n      `## AI Opportunities`,\n      ...aiOpps.map((o, i) => [\n        `### ${i + 1}. ${o.title}`,\n        `**Why it matters:** ${o.why_it_matters}`,\n        `**Demo hook:** ${o.demonstration_hook}`,\n        ``\n      ]).flat(),\n      `## Objections & Rebuttals`,\n      ...objections.map((o, i) => [\n        `### Objection ${i + 1}: \"${o.objection}\"`,\n        `**Rebuttal:** ${o.rebuttal}`,\n        ``\n      ]).flat(),\n      `## Opening Script`,\n      brief.opening_script || 'No script available'\n    ];\n\n    return {\n      format: 'markdown',\n      content: sections.join('\\n'),\n      run_id: meta.run_id || 'unknown'\n    };\n  }\n\n  // Email Renderer\n  function renderForEmail(brief, inputData) {\n    const meta = brief.meta || {};\n    const execSummary = brief.executive_summary || {};\n    const routing = inputData.routing || {};\n\n    return {\n      to: routing.email_to || null,\n      cc: routing.email_cc || [],\n      subject: `Deal Prep Brief: ${meta.organization_name || 'Organization'}`,\n      body_html: `\n        <h2>Deal Preparation Brief</h2>\n        <p><strong>Organization:</strong> ${meta.organization_name || 'Unknown'}</p>\n        <p><strong>Website:</strong> <a href=\"${meta.organization_website || '#'}\">${meta.organization_website || 'Unknown'}</a></p>\n        <p><strong>Contact:</strong> ${meta.requester_name || 'Unknown'} (${meta.requester_title || 'Unknown'})</p>\n        \n        <h3>Executive Summary</h3>\n        <p>${execSummary.summary || 'No summary available'}</p>\n        \n        <h3>Top 3 Opportunities</h3>\n        <ol>\n          ${(execSummary.top_opportunities || []).map(o => `<li>${o}</li>`).join('')}\n        </ol>\n        \n        <p><em>Full brief available in CRM. Run ID: ${meta.run_id || 'unknown'}</em></p>\n      `,\n      body_text: `\n  Deal Preparation Brief\n\n  Organization: ${meta.organization_name || 'Unknown'}\n  Website: ${meta.organization_website || 'Unknown'}\n  Contact: ${meta.requester_name || 'Unknown'} (${meta.requester_title || 'Unknown'})\n\n  Executive Summary:\n  ${execSummary.summary || 'No summary available'}\n\n  Top 3 Opportunities:\n  ${(execSummary.top_opportunities || []).map((o, i) => `${i + 1}. ${o}`).join('\\n')}\n\n  Full brief available in CRM. Run ID: ${meta.run_id || 'unknown'}\n      `,\n      run_id: meta.run_id || 'unknown'\n    };\n  }\n\n  // Motion Task Renderer\n  function renderForMotion(brief, inputData) {\n    const meta = brief.meta || {};\n    const execSummary = brief.executive_summary || {};\n    const aiOpps = brief.artificial_intelligence_opportunities || [];\n    const demoPlan = brief.demonstration_plan || {};\n    const routing = inputData.routing || {};\n    const inputMeta = inputData.meta || {};\n\n    const meetingTime = inputMeta.requested_meeting_at;\n    let dueDate = null;\n\n    if (meetingTime) {\n      const meetingDate = new Date(meetingTime);\n      meetingDate.setHours(meetingDate.getHours() - 2);\n      dueDate = meetingDate.toISOString();\n    }\n\n    return {\n      title: `Deal Prep - ${meta.organization_name || 'Organization'}`,\n      body: `\n  ## Top Opportunities\n  ${(execSummary.top_opportunities || []).map((o, i) => `${i + 1}. ${o}`).join('\\n')}\n\n  ## Key Talking Points\n  - ${demoPlan.opening || 'Prepare opening remarks'}\n  - Focus on: ${aiOpps.map(a => a.title).join(', ') || 'AI opportunities'}\n\n  ## Run ID\n  ${meta.run_id || 'unknown'}\n\n  [Full brief in CRM]\n      `,\n      workspace: routing.motion_workspace || null,\n      due_date: dueDate,\n      run_id: meta.run_id || 'unknown'\n    };\n  }\n\n  // Execute renderers\n  const crmOutput = renderForCRM(brief);\n  const emailOutput = renderForEmail(brief, normalized);\n  const motionOutput = renderForMotion(brief, normalized);\n\n  console.log('[Renderer] CRM output generated:', crmOutput.content.length, 'chars');\n  console.log('[Renderer] Email output generated');\n  console.log('[Renderer] Motion task output generated');\n\n  // Update run artifact\n  runArtifact.rendered_outputs = {\n    crm: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-crm.json`,\n    email: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-email.json`,\n    motion: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-motion.json`,\n    markdown: `s3://deal-prep-artifacts/deal-prep/${runId}/rendered-markdown.md`\n  };\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      brief,\n      renderedOutputs: {\n        crm: crmOutput,\n        email: emailOutput,\n        motion: motionOutput\n      }\n    }\n  }];"
                },
                "id": "f205dd03-46cd-4451-876a-e68708d63be4",
                "name": "Render Outputs",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    2960,
                    256
                ]
            },
            {
                "parameters": {
                    "jsCode": "/**\n * Execute Deliveries Node\n * \n * Calls executeDeliveries() with all adapters.\n * Uses Promise.allSettled for independence.\n * Updates run artifact with delivery status.\n * \n * Implementation Spec Section 11 & 12: Delivery Tracking and External Interfaces\n */\n\nconst { normalized, runId, runArtifact, brief, renderedOutputs } = $input.first().json;\n\n// Delivery adapter stubs - in production, use actual adapters\nasync function deliverToCRM(crmOutput, routing) {\n  try {\n    console.log('[CRM Adapter] Delivering to CRM...');\n    // In production:\n    // await crmAdapter.upsertOrganization(crmOutput);\n    // await crmAdapter.attachBrief(crmOutput);\n    \n    // Simulated success\n    return { success: true, message: 'CRM delivery successful' };\n  } catch (error) {\n    return { success: false, error: error.message };\n  }\n}\n\nasync function deliverEmail(emailOutput, routing) {\n  try {\n    console.log('[Email Adapter] Sending email...');\n    // In production:\n    // await emailAdapter.send(emailOutput);\n    \n    if (!routing.email_to) {\n      return { success: false, error: 'No email recipient configured' };\n    }\n    \n    // Simulated success\n    return { success: true, message: `Email sent to ${routing.email_to}` };\n  } catch (error) {\n    return { success: false, error: error.message };\n  }\n}\n\nasync function deliverToMotion(motionOutput, routing) {\n  try {\n    console.log('[Motion Adapter] Creating task...');\n    // In production:\n    // await motionAdapter.createTask(motionOutput);\n    \n    if (!routing.motion_workspace) {\n      return { success: false, error: 'No Motion workspace configured' };\n    }\n    \n    // Simulated success\n    return { success: true, message: 'Motion task created' };\n  } catch (error) {\n    return { success: false, error: error.message };\n  }\n}\n\n// Execute all deliveries in parallel using Promise.allSettled (spec 11.3)\nconst deliveryPromises = [\n  deliverToCRM(renderedOutputs.crm, normalized.routing),\n  deliverEmail(renderedOutputs.email, normalized.routing),\n  deliverToMotion(renderedOutputs.motion, normalized.routing)\n];\n\nconst results = await Promise.allSettled(deliveryPromises);\nconst [crmResult, emailResult, motionResult] = results;\n\nconst now = new Date().toISOString();\n\n// Update delivery status in run artifact (spec 11.2)\nrunArtifact.deliveries = {\n  customer_relationship_management: {\n    status: crmResult.status === 'fulfilled' && crmResult.value.success ? 'success' : 'failed',\n    attempted_at: now,\n    error: crmResult.status === 'fulfilled' ? (crmResult.value.error || null) : crmResult.reason?.message\n  },\n  email: {\n    status: emailResult.status === 'fulfilled' && emailResult.value.success ? 'success' : 'failed',\n    attempted_at: now,\n    error: emailResult.status === 'fulfilled' ? (emailResult.value.error || null) : emailResult.reason?.message\n  },\n  motion: {\n    status: motionResult.status === 'fulfilled' && motionResult.value.success ? 'success' : 'failed',\n    attempted_at: now,\n    error: motionResult.status === 'fulfilled' ? (motionResult.value.error || null) : motionResult.reason?.message\n  }\n};\n\nconsole.log('[Delivery] CRM:', runArtifact.deliveries.customer_relationship_management.status);\nconsole.log('[Delivery] Email:', runArtifact.deliveries.email.status);\nconsole.log('[Delivery] Motion:', runArtifact.deliveries.motion.status);\n\nreturn [{\n  json: {\n    normalized,\n    runId,\n    runArtifact,\n    brief,\n    renderedOutputs,\n    deliveryResults: {\n      crm: crmResult,\n      email: emailResult,\n      motion: motionResult\n    }\n  }\n}];"
                },
                "id": "58f08dd0-7e67-47fb-a03e-69f39195ebd5",
                "name": "Execute Deliveries",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    3632,
                    256
                ],
                "continueOnFail": true
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * Finalize Run Node\n   * \n   * Updates run artifact with completed_at.\n   * Calculates final status based on all delivery outcomes.\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { organization: {}, meta: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || {};\n  runArtifact.errors = runArtifact.errors || [];\n  runArtifact.metadata = runArtifact.metadata || {};\n  runArtifact.deliveries = runArtifact.deliveries || {\n    customer_relationship_management: { status: 'not_attempted' },\n    email: { status: 'not_attempted' },\n    motion: { status: 'not_attempted' }\n  };\n  const brief = input.brief || { executive_summary: {} };\n  const renderedOutputs = input.renderedOutputs || {};\n  const deliveryResults = input.deliveryResults || {};\n\n  // Calculate final status\n  function calculateFinalStatus(deliveries, errors) {\n    const crm = deliveries.customer_relationship_management || { status: 'not_attempted' };\n    const email = deliveries.email || { status: 'not_attempted' };\n    const motion = deliveries.motion || { status: 'not_attempted' };\n\n    const statuses = [crm.status, email.status, motion.status];\n\n    const successCount = statuses.filter(s => s === 'success').length;\n    const failedCount = statuses.filter(s => s === 'failed').length;\n\n    if (errors.length > 0 && successCount === 0) {\n      return 'failed';\n    }\n    if (failedCount === 3) {\n      return 'failed';\n    }\n    if (successCount === 3) {\n      return 'completed';\n    }\n    return 'completed_with_errors';\n  }\n\n  // Finalize run artifact\n  runArtifact.completed_at = new Date().toISOString();\n  runArtifact.started_at = runArtifact.started_at || normalized.meta?.received_at || new Date().toISOString();\n  runArtifact.status = calculateFinalStatus(runArtifact.deliveries, runArtifact.errors);\n\n  // Calculate duration\n  const startTime = new Date(runArtifact.started_at).getTime();\n  const endTime = new Date(runArtifact.completed_at).getTime();\n  runArtifact.metadata.duration_ms = endTime - startTime;\n  runArtifact.trigger_source = runArtifact.trigger_source || normalized.meta?.trigger_source || 'unknown';\n\n  console.log('[Finalize] Run completed');\n  console.log('[Finalize] Status:', runArtifact.status);\n  console.log('[Finalize] Duration:', runArtifact.metadata.duration_ms, 'ms');\n  console.log('[Finalize] Errors:', runArtifact.errors.length);\n\n  // Log metrics\n  const metrics = {\n    run_id: runId,\n    status: runArtifact.status,\n    duration_ms: runArtifact.metadata.duration_ms,\n    trigger_source: runArtifact.trigger_source,\n    organization: normalized.organization?.name || normalized.organization?.domain || 'unknown',\n    deliveries: {\n      crm: runArtifact.deliveries.customer_relationship_management?.status || 'not_attempted',\n      email: runArtifact.deliveries.email?.status || 'not_attempted',\n      motion: runArtifact.deliveries.motion?.status || 'not_attempted'\n    },\n    error_count: runArtifact.errors.length,\n    timestamp: runArtifact.completed_at\n  };\n\n  console.log('[Metrics]', JSON.stringify(metrics));\n\n  return [{\n    json: {\n      success: runArtifact.status !== 'failed',\n      runId,\n      status: runArtifact.status,\n      runArtifact,\n      brief,\n      metrics\n    }\n  }];"
                },
                "id": "0edbffc6-aefb-45d9-8e78-40a69207beb6",
                "name": "Finalize Run",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    3856,
                    256
                ]
            },
            {
                "parameters": {
                    "jsCode": "// Skip node - run was already completed (idempotency check)\n// With responseMode: onReceived, we can't respond again\n// Just log and end the flow\nconsole.log('[Skip] Run already completed, skipping duplicate execution');\nreturn [];"
                },
                "id": "85f28568-d8f3-468f-b558-16752fb11232",
                "name": "Skip (Already Complete)",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    1408,
                    64
                ]
            },
            {
                "parameters": {
                    "jsCode": "// End of workflow - with responseMode: onReceived, webhook already responded\n// Log completion for monitoring\nconst input = $input.first().json;\nconsole.log('[Complete] Workflow finished for run:', input.runId || 'unknown');\nconsole.log('[Complete] Status:', input.runArtifact?.status || 'unknown');\nreturn [{ json: { completed: true, runId: input.runId } }];"
                },
                "id": "0df60204-a094-4052-852e-07776cd39359",
                "name": "Log Completion",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    4080,
                    256
                ]
            },
            {
                "parameters": {
                    "content": "## Level 2 Deal Preparation Pipeline\n\nThis workflow implements the complete Deal Prep pipeline per the AI_Deal_Prep_Implementation_Spec.\n\n### Trigger Options:\n- **Webhook (Inbound)**: POST /deal-prep with JSON body\n- **Manual (Outbound)**: Click \"Execute\" for outbound prospecting\n\n### Pipeline Steps:\n1. Normalize Input\n2. Generate Run ID (idempotency)\n3. Initialize Run Artifact\n4. Website Scrape (with retry)\n5. Person Enrichment (non-blocking)\n6. LLM Synthesis (Claude)\n7. Validate Brief\n8. Render Outputs (CRM, Email, Motion)\n9. Execute Deliveries\n10. Finalize Run",
                    "height": 380,
                    "width": 300
                },
                "id": "f191e0af-8ef3-4ca3-94ed-21696068dea3",
                "name": "Sticky Note",
                "type": "n8n-nodes-base.stickyNote",
                "typeVersion": 1,
                "position": [
                    0,
                    0
                ]
            },
            {
                "parameters": {
                    "content": "### Error Handling\n\n- Scrape: 2 retries (30s, 120s backoff)\n- Enrichment: Non-blocking, always continues\n- LLM: 1 retry on validation failure\n- Deliveries: Independent (Promise.allSettled)\n- All errors logged to run artifact",
                    "width": 260
                },
                "id": "f3ecea55-03f6-4cec-a025-1816e469d8b5",
                "name": "Error Handling Note",
                "type": "n8n-nodes-base.stickyNote",
                "typeVersion": 1,
                "position": [
                    1600,
                    64
                ]
            },
            {
                "parameters": {
                    "content": "### Observability\n\n- Console logs with [Module] prefix\n- Metrics emitted at finalization\n- All artifacts stored to S3\n- Run duration tracked",
                    "height": 140
                },
                "id": "7b07cf9b-5dce-4269-b571-794b527591f8",
                "name": "Observability Note",
                "type": "n8n-nodes-base.stickyNote",
                "typeVersion": 1,
                "position": [
                    2928,
                    64
                ]
            },
            {
                "parameters": {
                    "jsCode": "// Log AI Ideas - Extract and format AI opportunities for product roadmap\n  const runArtifact = $input.first().json.runArtifact || {};\n  const validatedBrief = $input.first().json.brief || $input.first().json.validatedBrief || {};\n\n  // Extract data\n  const organizationName = validatedBrief.meta?.organization_name || runArtifact.organization?.name || 'Unknown Organization';\n  const organizationWebsite = validatedBrief.meta?.organization_website || runArtifact.organization?.website || '';\n  const contactName = validatedBrief.meta?.requester_name || runArtifact.contact?.full_name || '';\n  const runId = runArtifact.run_id || 'unknown';\n  const generatedAt = new Date().toISOString();\n\n  // Get MyRecruiter opportunities from the brief\n  const myrecruiterOpportunities = validatedBrief.myrecruiter_opportunities || [];\n\n  // Get Blue Sky ideas from the brief\n  const blueSkyIdeas = validatedBrief.blue_sky_ideas || [];\n\n  // Determine organization type from content\n  const missionText = (validatedBrief.organization_understanding?.mission || '').toLowerCase();\n  let orgType = 'nonprofit';\n  if (missionText.includes('mentor')) orgType = 'mentoring';\n  else if (missionText.includes('food') || missionText.includes('hunger')) orgType = 'food-security';\n  else if (missionText.includes('education') || missionText.includes('school')) orgType = 'education';\n  else if (missionText.includes('health') || missionText.includes('medical')) orgType = 'healthcare';\n  else if (missionText.includes('environment') || missionText.includes('climate')) orgType = 'environmental';\n\n  // Assess feasibility for MyRecruiter opportunities\n  function assessFeasibility(opp) {\n    const text = (opp.title + ' ' + (opp.myrecruiter_solution || opp.why_it_matters || '')).toLowerCase();\n    if (text.includes('chatbot') || text.includes('faq') || text.includes('lead capture') ||\n        text.includes('form') || text.includes('24/7') || text.includes('knowledge base') ||\n        text.includes('conversational') || text.includes('qualification')) {\n      return 'high';\n    } else if (text.includes('integration') || text.includes('crm') || text.includes('routing') ||\n               text.includes('analytics') || text.includes('reporting')) {\n      return 'medium';\n    }\n    return 'low';\n  }\n\n  // Process MyRecruiter opportunities with feasibility\n  const processedMyRecruiterOpps = myrecruiterOpportunities.map(opp => ({\n    ...opp,\n    feasibility: assessFeasibility(opp)\n  }));\n\n  // Count by feasibility\n  const highCount = processedMyRecruiterOpps.filter(o => o.feasibility === 'high').length;\n  const mediumCount = processedMyRecruiterOpps.filter(o => o.feasibility === 'medium').length;\n  const lowCount = processedMyRecruiterOpps.filter(o => o.feasibility === 'low').length;\n\n  // Create org identifier for S3 path\n  const orgIdentifier = organizationName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'unknown';\n\n  // Build the AI Ideas log object\n  const aiIdeasLog = {\n    metadata: {\n      organization_name: organizationName,\n      organization_website: organizationWebsite,\n      contact_name: contactName,\n      run_id: runId,\n      generated_at: generatedAt,\n      organization_type: orgType,\n      pages_analyzed: validatedBrief.meta?.pages_scraped || 0\n    },\n    myrecruiter_opportunities: processedMyRecruiterOpps,\n    blue_sky_ideas: blueSkyIdeas,\n    summary: {\n      total_myrecruiter_opportunities: myrecruiterOpportunities.length,\n      total_blue_sky_ideas: blueSkyIdeas.length,\n      feasibility_breakdown: {\n        high: highCount,\n        medium: mediumCount,\n        low: lowCount\n      }\n    }\n  };\n\n  // Generate HTML document\n  const aiIdeasHtml = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"UTF-8\">\n      <title>AI Ideas Log - ${organizationName}</title>\n      <style>\n        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');\n        \n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        \n        body {\n          font-family: 'Plus Jakarta Sans', Arial, sans-serif;\n          font-size: 11pt;\n          line-height: 1.6;\n          color: #1e293b;\n          background: #f8fafc;\n        }\n        \n        .header {\n          background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);\n          color: white;\n          padding: 30px 40px;\n        }\n        \n        .header-top {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-bottom: 15px;\n        }\n        \n        .logo {\n          font-size: 24pt;\n          font-weight: 700;\n          display: flex;\n          align-items: center;\n          gap: 12px;\n        }\n        \n        .logo-icon {\n          width: 44px;\n          height: 44px;\n        }\n        \n        .logo-my { color: #50C878; }\n        .logo-recruiter { color: white; }\n        \n        .doc-type {\n          font-size: 10pt;\n          color: #94a3b8;\n          text-transform: uppercase;\n          letter-spacing: 1px;\n        }\n        \n        .org-name {\n          font-size: 24pt;\n          font-weight: 700;\n          margin-bottom: 5px;\n        }\n        \n        .org-website {\n          font-size: 11pt;\n          color: #50C878;\n        }\n        \n        .meta-bar {\n          background: white;\n          padding: 15px 40px;\n          border-bottom: 1px solid #e2e8f0;\n          display: flex;\n          gap: 30px;\n          font-size: 10pt;\n          flex-wrap: wrap;\n        }\n        \n        .meta-item { color: #64748b; }\n        .meta-item strong { color: #1e293b; }\n        \n        .content {\n          padding: 30px 40px;\n          max-width: 1100px;\n          margin: 0 auto;\n        }\n        \n        .summary-cards {\n          display: flex;\n          gap: 15px;\n          margin-bottom: 30px;\n          flex-wrap: wrap;\n        }\n        \n        .summary-card {\n          flex: 1;\n          min-width: 120px;\n          background: white;\n          border-radius: 10px;\n          padding: 20px;\n          text-align: center;\n          box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        }\n        \n        .summary-card .number {\n          font-size: 28pt;\n          font-weight: 700;\n          color: #1e293b;\n        }\n        \n        .summary-card .number.high { color: #10b981; }\n        .summary-card .number.medium { color: #f59e0b; }\n        .summary-card .number.low { color: #ef4444; }\n        .summary-card .number.blue-sky { color: #8b5cf6; }\n        \n        .summary-card .label {\n          font-size: 9pt;\n          color: #64748b;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n          margin-top: 5px;\n        }\n        \n        .section-title {\n          font-size: 14pt;\n          font-weight: 700;\n          color: #0f172a;\n          margin: 30px 0 20px 0;\n          padding-bottom: 10px;\n          border-bottom: 2px solid #50C878;\n          display: flex;\n          align-items: center;\n          gap: 10px;\n        }\n        \n        .section-title.blue-sky {\n          border-bottom-color: #8b5cf6;\n        }\n        \n        .section-icon {\n          width: 24px;\n          height: 24px;\n        }\n        \n        .opportunity-card {\n          background: white;\n          border-radius: 10px;\n          padding: 25px;\n          margin-bottom: 20px;\n          box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n          border-left: 4px solid #50C878;\n        }\n        \n        .opportunity-card.blue-sky {\n          border-left-color: #8b5cf6;\n          background: linear-gradient(135deg, #faf5ff 0%, #ffffff 100%);\n        }\n        \n        .opp-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: flex-start;\n          margin-bottom: 15px;\n          flex-wrap: wrap;\n          gap: 10px;\n        }\n        \n        .opp-title {\n          font-size: 13pt;\n          font-weight: 700;\n          color: #0f172a;\n          flex: 1;\n        }\n        \n        .feasibility-badge {\n          font-size: 9pt;\n          padding: 4px 12px;\n          border-radius: 20px;\n          font-weight: 600;\n          white-space: nowrap;\n        }\n        \n        .feasibility-high {\n          background: #d1fae5;\n          color: #065f46;\n        }\n        \n        .feasibility-medium {\n          background: #fef3c7;\n          color: #92400e;\n        }\n        \n        .feasibility-low {\n          background: #fee2e2;\n          color: #991b1b;\n        }\n        \n        .badge-blue-sky {\n          background: #ede9fe;\n          color: #5b21b6;\n        }\n        \n        .opp-section {\n          margin-bottom: 15px;\n        }\n        \n        .opp-section:last-child {\n          margin-bottom: 0;\n        }\n        \n        .opp-section-label {\n          font-size: 9pt;\n          font-weight: 600;\n          color: #50C878;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n          margin-bottom: 5px;\n        }\n        \n        .opp-section-label.blue-sky {\n          color: #8b5cf6;\n        }\n        \n        .opp-section-content {\n          font-size: 10.5pt;\n          color: #334155;\n          line-height: 1.7;\n        }\n        \n        .solution-box {\n          background: #f0fdf4;\n          border-radius: 8px;\n          padding: 15px;\n          font-size: 10.5pt;\n          color: #166534;\n          border: 1px solid #bbf7d0;\n        }\n        \n        .solution-box.blue-sky {\n          background: #faf5ff;\n          color: #5b21b6;\n          border-color: #ddd6fe;\n        }\n        \n        .roadmap-box {\n          background: #fef3c7;\n          border-radius: 8px;\n          padding: 15px;\n          font-size: 10.5pt;\n          color: #92400e;\n          border: 1px solid #fde68a;\n        }\n        \n        .demo-box {\n          background: #fdf4ff;\n          border-radius: 8px;\n          padding: 15px;\n          font-size: 10.5pt;\n          color: #86198f;\n          border: 1px solid #f5d0fe;\n        }\n        \n        .context-section {\n          background: #f1f5f9;\n          border-radius: 10px;\n          padding: 25px;\n          margin-top: 30px;\n        }\n        \n        .context-grid {\n          display: grid;\n          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n          gap: 20px;\n          margin-top: 15px;\n        }\n        \n        .context-item {\n          text-align: center;\n        }\n        \n        .context-value {\n          font-size: 14pt;\n          font-weight: 700;\n          color: #0f172a;\n        }\n        \n        .context-label {\n          font-size: 9pt;\n          color: #64748b;\n          text-transform: uppercase;\n          margin-top: 5px;\n        }\n        \n        .divider {\n          height: 2px;\n          background: linear-gradient(90deg, #50C878 0%, #8b5cf6 100%);\n          margin: 40px 0;\n          border-radius: 2px;\n        }\n        \n        .footer {\n          text-align: center;\n          padding: 20px;\n          color: #94a3b8;\n          font-size: 9pt;\n        }\n        \n        @media print {\n          body { background: white; }\n          .content { padding: 20px; }\n          .opportunity-card { break-inside: avoid; }\n        }\n      </style>\n    </head>\n    <body>\n    <div class=\"header\">\n      <div class=\"header-top\">\n        <div class=\"logo\">\n          <svg class=\"logo-icon\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\n            <circle cx=\"50\" cy=\"8\" r=\"8\" fill=\"#50C878\"/>\n            <circle cx=\"8\" cy=\"50\" r=\"8\" fill=\"#50C878\"/>\n            <circle cx=\"92\" cy=\"50\" r=\"8\" fill=\"#50C878\"/>\n            <circle cx=\"50\" cy=\"92\" r=\"8\" fill=\"#8b5cf6\"/>\n            <path d=\"M50 16 Q80 20 84 50 Q80 80 50 84\" stroke=\"#50C878\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n            <path d=\"M50 16 Q20 20 16 50 Q20 80 50 84\" stroke=\"#50C878\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n            <path d=\"M25 78 Q50 100 75 78\" stroke=\"#8b5cf6\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n            <circle cx=\"35\" cy=\"50\" r=\"7\" fill=\"#8b5cf6\"/>\n            <circle cx=\"50\" cy=\"50\" r=\"7\" fill=\"#8b5cf6\"/>\n            <circle cx=\"65\" cy=\"50\" r=\"7\" fill=\"#8b5cf6\"/>\n          </svg>\n          <span><span class=\"logo-my\">My</span><span class=\"logo-recruiter\">Recruiter</span></span>\n        </div>\n        <div class=\"doc-type\">AI Ideas Log \u2022 Product Roadmap</div>\n      </div>\n      <div class=\"org-name\">${organizationName}</div>\n      <div class=\"org-website\">${organizationWebsite}</div>\n    </div>\n\n    <div class=\"meta-bar\">\n      <div class=\"meta-item\"><strong>Contact:</strong> ${contactName}</div>\n      <div class=\"meta-item\"><strong>Generated:</strong> ${new Date(generatedAt).toLocaleString()}</div>\n      <div class=\"meta-item\"><strong>Run ID:</strong> ${runId}</div>\n      <div class=\"meta-item\"><strong>Org Type:</strong> ${orgType}</div>\n    </div>\n\n    <div class=\"content\">\n      \n      <div class=\"summary-cards\">\n        <div class=\"summary-card\">\n          <div class=\"number\">${myrecruiterOpportunities.length}</div>\n          <div class=\"label\">MyRecruiter Opps</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number blue-sky\">${blueSkyIdeas.length}</div>\n          <div class=\"label\">Blue Sky Ideas</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number high\">${highCount}</div>\n          <div class=\"label\">High Feasibility</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number medium\">${mediumCount}</div>\n          <div class=\"label\">Medium Feasibility</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"number low\">${lowCount}</div>\n          <div class=\"label\">Low Feasibility</div>\n        </div>\n      </div>\n\n      <div class=\"section-title\">\n        <svg class=\"section-icon\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n          <path d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" stroke=\"#50C878\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n        </svg>\n        MyRecruiter Opportunities (Sell Today)\n      </div>\n      \n      ${processedMyRecruiterOpps.map((opp, i) => `\n      <div class=\"opportunity-card\">\n        <div class=\"opp-header\">\n          <div class=\"opp-title\">${i + 1}. ${opp.title || 'Untitled Opportunity'}</div>\n          <span class=\"feasibility-badge feasibility-${opp.feasibility}\">${opp.feasibility === 'high' ? '\u2713 High - Core Feature' : opp.feasibility === 'medium' ? '\u25d0 Medium - With Integration' : '\u25cb Low - Custom Work'}</span>\n        </div>\n        \n        ${opp.why_it_matters ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label\">Why It Matters</div>\n          <div class=\"opp-section-content\">${opp.why_it_matters}</div>\n        </div>\n        ` : ''}\n        \n        ${opp.myrecruiter_solution ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label\">MyRecruiter Solution</div>\n          <div class=\"solution-box\">${opp.myrecruiter_solution}</div>\n        </div>\n        ` : ''}\n        \n        ${opp.demonstration_hook ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label\">Demo Hook</div>\n          <div class=\"demo-box\">${opp.demonstration_hook}</div>\n        </div>\n        ` : ''}\n      </div>\n      `).join('')}\n\n      <div class=\"divider\"></div>\n\n      <div class=\"section-title blue-sky\">\n        <svg class=\"section-icon\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n          <path d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" stroke=\"#8b5cf6\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n        </svg>\n        Blue Sky Ideas (Product Roadmap)\n      </div>\n      \n      ${blueSkyIdeas.length > 0 ? blueSkyIdeas.map((idea, i) => `\n      <div class=\"opportunity-card blue-sky\">\n        <div class=\"opp-header\">\n          <div class=\"opp-title\">${i + 1}. ${idea.title || 'Untitled Idea'}</div>\n          <span class=\"feasibility-badge badge-blue-sky\">\ud83d\udca1 Future Feature</span>\n        </div>\n        \n        ${idea.why_it_matters ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label blue-sky\">Why It Matters</div>\n          <div class=\"opp-section-content\">${idea.why_it_matters}</div>\n        </div>\n        ` : ''}\n        \n        ${idea.ai_solution ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label blue-sky\">AI Solution</div>\n          <div class=\"solution-box blue-sky\">${idea.ai_solution}</div>\n        </div>\n        ` : ''}\n        \n        ${idea.roadmap_potential ? `\n        <div class=\"opp-section\">\n          <div class=\"opp-section-label blue-sky\">Roadmap Potential</div>\n          <div class=\"roadmap-box\">${idea.roadmap_potential}</div>\n        </div>\n        ` : ''}\n      </div>\n      `).join('') : `\n      <div class=\"opportunity-card blue-sky\">\n        <div class=\"opp-section-content\" style=\"text-align: center; padding: 20px; color: #64748b;\">\n          No blue sky ideas generated. Update the LLM Synthesis prompt to include the blue_sky_ideas schema.\n        </div>\n      </div>\n      `}\n\n      <div class=\"context-section\">\n        <div class=\"section-title\" style=\"margin-bottom: 0; border: none; padding: 0;\">Organization Context</div>\n        <div class=\"context-grid\">\n          <div class=\"context-item\">\n            <div class=\"context-value\">${orgType}</div>\n            <div class=\"context-label\">Organization Type</div>\n          </div>\n          <div class=\"context-item\">\n            <div class=\"context-value\">${validatedBrief.meta?.pages_scraped || 0}</div>\n            <div class=\"context-label\">Pages Analyzed</div>\n          </div>\n          <div class=\"context-item\">\n            <div class=\"context-value\">${myrecruiterOpportunities.length + blueSkyIdeas.length}</div>\n            <div class=\"context-label\">Total Ideas</div>\n          </div>\n          <div class=\"context-item\">\n            <div class=\"context-value\">${new Date(generatedAt).toLocaleDateString()}</div>\n            <div class=\"context-label\">Generated</div>\n          </div>\n        </div>\n      </div>\n      \n    </div>\n    \n    <div class=\"footer\">\n      Generated by MyRecruiter Deal Prep Pipeline \u2022 ${new Date(generatedAt).toLocaleString()} \u2022 Internal Use Only\n    </div>\n    </body>\n    </html>\n  `;\n\n  // Return everything needed for S3 upload\n  return {\n    runArtifact,\n    validatedBrief,\n    aiIdeasLog,\n    aiIdeasHtml,\n    orgIdentifier,\n    runId\n  };"
                },
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    2304,
                    256
                ],
                "id": "0b94a4aa-b933-4fa3-8384-33b3a37464c9",
                "name": "Log AI Ideas"
            },
            {
                "parameters": {
                    "jsCode": "/**\n   * Generate PDF Node\n   * \n   * Creates a branded PDF brief using HTML template and stores to S3.\n   */\n\n  const input = $input.first().json;\n  const normalized = input.normalized || { meta: {}, organization: {}, contact: {} };\n  const runId = input.runId || 'unknown';\n  const runArtifact = input.runArtifact || { errors: [], rendered_outputs: {} };\n  runArtifact.errors = runArtifact.errors || [];\n  const brief = input.brief || input.validatedBrief || {};\n  const renderedOutputs = input.renderedOutputs || {};\n  const siteMap = input.siteMap || { sections: {}, total_pages: 0 };\n\n  // Create proper orgIdentifier from organization name\n  const organizationName = brief.meta?.organization_name || normalized.organization?.name || 'Unknown';\n  const orgIdentifier = input.orgIdentifier || organizationName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'unknown';\n\n  console.log('[PDFGen] Organization:', organizationName);\n  console.log('[PDFGen] Org Identifier:', orgIdentifier);\n  console.log('[PDFGen] Run ID:', runId);\n\n  // MyRecruiter branding\n  const BRAND = {\n    primaryColor: '#50C878',\n    accentPink: '#D98AD9',\n    darkBg: '#0f172a',\n    lightBg: '#f8fafc',\n    textDark: '#1e293b',\n    textMuted: '#64748b',\n    font: 'Plus Jakarta Sans, Arial, sans-serif'\n  };\n\n  function formatDate(isoString) {\n    const date = new Date(isoString);\n    return date.toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  }\n\n  function buildPDFHtml(brief, siteMap, brand) {\n    const meta = brief.meta || {};\n    const exec = brief.executive_summary || {};\n    const org = brief.organization_understanding || {};\n    const site = brief.site_structure || {};\n    const web = brief.website_analysis || {};\n    const leadership = brief.leadership_and_staff || {};\n    const opps = brief.myrecruiter_opportunities || brief.artificial_intelligence_opportunities || [];\n    const objections = brief.objections_and_rebuttals || [];\n    const demo = brief.demonstration_plan || {};\n    const emails = brief.follow_up_emails || {};\n\n    return `\n  <!DOCTYPE html>\n  <html>\n  <head>\n    <meta charset=\"UTF-8\">\n    <style>\n      @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');\n      \n      * { margin: 0; padding: 0; box-sizing: border-box; }\n      \n      body {\n        font-family: ${brand.font};\n        font-size: 11pt;\n        line-height: 1.5;\n        color: ${brand.textDark};\n      }\n      \n      .header {\n        background: linear-gradient(135deg, ${brand.darkBg} 0%, #1e293b 100%);\n        color: white;\n        padding: 30px 40px;\n        margin-bottom: 0;\n      }\n      \n      .header-top {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 20px;\n      }\n      \n      .logo {\n        font-size: 24pt;\n        font-weight: 700;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n      \n      .logo-icon {\n        width: 44px;\n        height: 44px;\n      }\n      \n      .logo-my {\n        color: ${brand.primaryColor};\n      }\n      \n      .logo-recruiter {\n        color: white;\n      }\n      \n      .doc-type {\n        font-size: 10pt;\n        color: #94a3b8;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n      }\n      \n      .org-name {\n        font-size: 28pt;\n        font-weight: 700;\n        margin-bottom: 8px;\n      }\n      \n      .org-website {\n        font-size: 12pt;\n        color: ${brand.primaryColor};\n      }\n      \n      .meta-bar {\n        background: ${brand.lightBg};\n        padding: 15px 40px;\n        border-bottom: 1px solid #e2e8f0;\n        display: flex;\n        gap: 40px;\n        font-size: 10pt;\n      }\n      \n      .meta-item { color: ${brand.textMuted}; }\n      .meta-item strong { color: ${brand.textDark}; }\n      \n      .content {\n        padding: 30px 40px;\n      }\n      \n      .section {\n        margin-bottom: 25px;\n        page-break-inside: avoid;\n      }\n      \n      .section-title {\n        font-size: 14pt;\n        font-weight: 700;\n        color: ${brand.darkBg};\n        border-bottom: 2px solid ${brand.primaryColor};\n        padding-bottom: 8px;\n        margin-bottom: 15px;\n      }\n      \n      .summary-box {\n        background: ${brand.lightBg};\n        border-left: 4px solid ${brand.primaryColor};\n        padding: 15px 20px;\n        margin-bottom: 15px;\n      }\n      \n      .opportunity {\n        background: white;\n        border: 1px solid #e2e8f0;\n        border-radius: 8px;\n        padding: 15px;\n        margin-bottom: 12px;\n      }\n      \n      .opp-number {\n        background: ${brand.primaryColor};\n        color: white;\n        width: 24px;\n        height: 24px;\n        border-radius: 50%;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        font-weight: 700;\n        font-size: 12pt;\n        margin-right: 10px;\n      }\n      \n      .opp-title {\n        font-weight: 600;\n        font-size: 12pt;\n        display: inline;\n      }\n      \n      .opp-detail {\n        margin-top: 8px;\n        padding-left: 34px;\n        font-size: 10pt;\n        color: ${brand.textMuted};\n      }\n      \n      .opp-solution {\n        background: #ecfdf5;\n        border-radius: 4px;\n        padding: 8px 12px;\n        margin-top: 8px;\n        margin-left: 34px;\n        font-size: 10pt;\n      }\n      \n      .opp-solution strong {\n        color: ${brand.primaryColor};\n      }\n      \n      .site-structure {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 10px;\n      }\n      \n      .site-section {\n        background: ${brand.lightBg};\n        padding: 10px;\n        border-radius: 6px;\n        font-size: 10pt;\n        min-width: 120px;\n      }\n      \n      .site-section-name {\n        font-weight: 600;\n        color: ${brand.darkBg};\n      }\n      \n      .site-section-count {\n        color: ${brand.textMuted};\n        font-size: 9pt;\n      }\n      \n      ul { padding-left: 20px; }\n      li { margin-bottom: 5px; }\n      \n      .two-col {\n        display: flex;\n        gap: 20px;\n      }\n      \n      .two-col > div {\n        flex: 1;\n      }\n      \n      .objection {\n        background: #fef2f2;\n        border-radius: 6px;\n        padding: 12px;\n        margin-bottom: 10px;\n      }\n      \n      .objection-q {\n        font-weight: 600;\n        color: #991b1b;\n        font-size: 10pt;\n      }\n      \n      .objection-a {\n        margin-top: 6px;\n        font-size: 10pt;\n        color: ${brand.textDark};\n      }\n      \n      .script-box {\n        background: #f0fdf4;\n        border: 1px solid ${brand.primaryColor};\n        border-radius: 8px;\n        padding: 15px;\n        font-style: italic;\n      }\n      \n      .footer {\n        background: ${brand.darkBg};\n        color: white;\n        padding: 15px 40px;\n        font-size: 9pt;\n        display: flex;\n        justify-content: space-between;\n        margin-top: 30px;\n      }\n      \n      .footer a {\n        color: ${brand.primaryColor};\n        text-decoration: none;\n      }\n    </style>\n  </head>\n  <body>\n\n  <div class=\"header\">\n    <div class=\"header-top\">\n      <div class=\"logo\">\n        <svg class=\"logo-icon\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\n          <circle cx=\"50\" cy=\"8\" r=\"8\" fill=\"${brand.primaryColor}\"/>\n          <circle cx=\"8\" cy=\"50\" r=\"8\" fill=\"${brand.primaryColor}\"/>\n          <circle cx=\"92\" cy=\"50\" r=\"8\" fill=\"${brand.primaryColor}\"/>\n          <circle cx=\"50\" cy=\"92\" r=\"8\" fill=\"${brand.accentPink}\"/>\n          <path d=\"M50 16 Q80 20 84 50 Q80 80 50 84\" stroke=\"${brand.primaryColor}\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n          <path d=\"M50 16 Q20 20 16 50 Q20 80 50 84\" stroke=\"${brand.primaryColor}\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n          <path d=\"M25 78 Q50 100 75 78\" stroke=\"${brand.accentPink}\" stroke-width=\"8\" fill=\"none\" stroke-linecap=\"round\"/>\n          <circle cx=\"35\" cy=\"50\" r=\"7\" fill=\"${brand.accentPink}\"/>\n          <circle cx=\"50\" cy=\"50\" r=\"7\" fill=\"${brand.accentPink}\"/>\n          <circle cx=\"65\" cy=\"50\" r=\"7\" fill=\"${brand.accentPink}\"/>\n        </svg>\n        <span><span class=\"logo-my\">My</span><span class=\"logo-recruiter\">Recruiter</span></span>\n      </div>\n      <div class=\"doc-type\">Deal Preparation Brief</div>\n    </div>\n    <div class=\"org-name\">${meta.organization_name || 'Organization'}</div>\n    <div class=\"org-website\">${meta.organization_website || ''}</div>\n  </div>\n\n  <div class=\"meta-bar\">\n    <div class=\"meta-item\"><strong>Contact:</strong> ${meta.requester_name || 'N/A'}</div>\n    <div class=\"meta-item\"><strong>Generated:</strong> ${formatDate(meta.generated_at || new Date().toISOString())}</div>\n    <div class=\"meta-item\"><strong>Run ID:</strong> ${meta.run_id || 'N/A'}</div>\n    <div class=\"meta-item\"><strong>Pages Analyzed:</strong> ${meta.pages_scraped || 0}</div>\n  </div>\n\n  <div class=\"content\">\n\n    <div class=\"section\">\n      <div class=\"section-title\">Executive Summary</div>\n      <div class=\"summary-box\">${exec.summary || 'No summary available'}</div>\n      <strong>Top Opportunities:</strong>\n      <ol>\n        ${(exec.top_opportunities || []).map(o => '<li>' + o + '</li>').join('')}\n      </ol>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Organization Understanding</div>\n      <p><strong>Mission:</strong> ${org.mission || 'Not found'}</p>\n      ${org.programs && org.programs.length > 0 ? \n      '<p style=\"margin-top: 10px;\"><strong>Programs:</strong></p><ul>' +\n      org.programs.map(p => '<li><strong>' + p.name + ':</strong> ' + p.summary + '</li>').join('') +\n      '</ul>' : ''}\n      ${org.audiences && org.audiences.length > 0 ? \n      '<p style=\"margin-top: 10px;\"><strong>Target Audiences:</strong> ' + org.audiences.join(', ') + '</p>' : ''}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Website Analysis</div>\n      <p><strong>Overall Tone:</strong> ${web.overall_tone || 'Not analyzed'}</p>\n      <div class=\"two-col\" style=\"margin-top: 10px;\">\n        <div>\n          <strong>Strengths:</strong>\n          <ul>${(web.strengths || []).map(s => '<li>' + s + '</li>').join('')}</ul>\n        </div>\n        <div>\n          <strong>Gaps/Opportunities:</strong>\n          <ul>${(web.gaps || []).map(g => '<li>' + g + '</li>').join('')}</ul>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Leadership & Staff</div>\n      <p><strong>Executive Leader:</strong> ${leadership.executive_leader?.name || 'Not found'} ${leadership.executive_leader?.role ? '(' + leadership.executive_leader.role + ')' : ''}</p>\n      ${leadership.other_staff_mentions && leadership.other_staff_mentions.length > 0 ? \n      '<p style=\"margin-top: 8px;\"><strong>Other Staff:</strong></p><ul>' +\n      leadership.other_staff_mentions.map(s => '<li>' + s.name + ' - ' + s.role + '</li>').join('') +\n      '</ul>' : ''}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">MyRecruiter Opportunities</div>\n      ${opps.map(function(opp, i) {\n        return '<div class=\"opportunity\"><span class=\"opp-number\">' + (i + 1) + '</span><span class=\"opp-title\">' + opp.title + '</span><div class=\"opp-detail\">' + opp.why_it_matters + '</div>' + (opp.myrecruiter_solution ? '<div class=\"opp-solution\"><strong>MyRecruiter Solution:</strong> ' + opp.myrecruiter_solution + '</div>' : '') + '</div>';\n      }).join('')}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Objections & Rebuttals</div>\n      ${objections.map(function(obj) {\n        return '<div class=\"objection\"><div class=\"objection-q\">\"' + obj.objection + '\"</div><div class=\"objection-a\">' + obj.rebuttal + '</div></div>';\n      }).join('')}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Opening Script</div>\n      <div class=\"script-box\">${brief.opening_script || 'No script available'}</div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Demonstration Plan</div>\n      <p><strong>Opening:</strong> ${demo.opening || ''}</p>\n      <ol style=\"margin-top: 10px;\">\n        ${(demo.steps || []).map(s => '<li>' + s + '</li>').join('')}\n      </ol>\n      ${(demo.example_chatbot_responses || demo.example_bot_responses || []).length > 0 ? \n      '<p style=\"margin-top: 10px;\"><strong>Example Chatbot Responses:</strong></p><ul>' +\n      (demo.example_chatbot_responses || demo.example_bot_responses || []).map(r => '<li><em>\"' + r + '\"</em></li>').join('') +\n      '</ul>' : ''}\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Follow-Up Emails</div>\n      <div class=\"two-col\">\n        <div>\n          <strong>Short Version:</strong>\n          <p style=\"margin-top: 5px;\"><em>Subject: ${emails.short_version?.subject || ''}</em></p>\n          <p style=\"font-size: 10pt; margin-top: 5px;\">${emails.short_version?.body || ''}</p>\n        </div>\n        <div>\n          <strong>Warm Version:</strong>\n          <p style=\"margin-top: 5px;\"><em>Subject: ${emails.warm_version?.subject || ''}</em></p>\n          <p style=\"font-size: 10pt; margin-top: 5px;\">${emails.warm_version?.body || ''}</p>\n        </div>\n      </div>\n    </div>\n\n  </div>\n\n  <div class=\"footer\">\n    <div>Generated by <a href=\"https://myrecruiter.ai\"><span style=\"color: ${brand.primaryColor};\">My</span><span style=\"color: white;\">Recruiter</span>.ai</a></div>\n    <div>Run ID: ${meta.run_id || 'N/A'}</div>\n  </div>\n\n  </body>\n  </html>\n  `;\n  }\n\n  const pdfHtml = buildPDFHtml(brief, siteMap, BRAND);\n\n  const pdfData = {\n    html: pdfHtml,\n    filename: `deal-prep-brief-${orgIdentifier}-${runId}.pdf`,\n    generated_at: new Date().toISOString()\n  };\n\n  runArtifact.rendered_outputs = runArtifact.rendered_outputs || {};\n  runArtifact.rendered_outputs.pdf_html = `s3://deal-prep-artifacts/deal-prep/${orgIdentifier}/${runId}.html`;\n  runArtifact.rendered_outputs.pdf = `s3://deal-prep-artifacts/deal-prep/${orgIdentifier}/${runId}.pdf`;\n\n  console.log('[PDFGen] HTML generated:', pdfHtml.length, 'chars');\n  console.log('[PDFGen] Completed');\n\n  return [{\n    json: {\n      normalized,\n      runId,\n      runArtifact,\n      orgIdentifier,\n      brief,\n      renderedOutputs: {\n        ...renderedOutputs,\n        pdfHtml: pdfHtml,\n        pdfFilename: pdfData.filename\n      }\n    }\n  }];"
                },
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [
                    3184,
                    256
                ],
                "id": "b8a557e5-ec51-4a0f-96f5-b65aa6363bef",
                "name": "Generate PDF"
            },
            {
                "parameters": {
                    "operation": "upload",
                    "bucketName": "deal-prep-artifacts",
                    "fileName": "={{ \"ai-ideas/\" + $json.orgIdentifier + \"/\" + $json.runId + \".html\" }}",
                    "binaryData": false,
                    "fileContent": "={{ $json.aiIdeasHtml }}",
                    "additionalFields": {}
                },
                "type": "n8n-nodes-base.awsS3",
                "typeVersion": 2,
                "position": [
                    2512,
                    256
                ],
                "id": "aa0fa308-e53e-4238-91e5-e9f062a19c14",
                "name": "Upload AI Ideas",
                "credentials": {
                    "aws": {
                        "id": "cDZfZsEP8rjU0RBZ",
                        "name": "AWS (IAM) account"
                    }
                }
            },
            {
                "parameters": {
                    "operation": "upload",
                    "bucketName": "deal-prep-artifacts",
                    "fileName": "=deal-prep/{{ $json.orgIdentifier }}/{{ $json.runId }}.html",
                    "binaryData": false,
                    "fileContent": "{{ $json.rendered_outputs.pdf_html }}",
                    "additionalFields": {}
                },
                "type": "n8n-nodes-base.awsS3",
                "typeVersion": 2,
                "position": [
                    3408,
                    256
                ],
                "id": "da1a912a-45f5-401a-8f1a-d7c88cd25574",
                "name": "Upload Deal PDF",
                "credentials": {
                    "aws": {
                        "id": "cDZfZsEP8rjU0RBZ",
                        "name": "AWS (IAM) account"
                    }
                }
            },
            {
                "parameters": {
                    "method": "POST",
                    "url": "https://email.us-east-1.amazonaws.com/",
                    "authentication": "predefinedCredentialType",
                    "nodeCredentialType": "aws",
                    "sendBody": true,
                    "contentType": "form-urlencoded",
                    "bodyParameters": {
                        "parameters": [
                            {
                                "name": "Action",
                                "value": "SendEmail"
                            },
                            {
                                "name": "Source",
                                "value": "chris@myrecruiter.ai"
                            },
                            {
                                "name": "Destination.ToAddresses.member.1",
                                "value": "chris@myrecruiter.ai"
                            },
                            {
                                "name": "Message.Subject.Data",
                                "value": "=Deal Prep Submission - {{ $('Generate Run ID').item.json.normalized.organization.name || 'Unknown Org' }}"
                            },
                            {
                                "name": "Message.Body.Text.Data",
                                "value": "=You have new documents ready.\n\nThe AI log document can be found here:\ns3://deal-prep-artifacts/ai-ideas/{{ $('Generate Run ID').item.json.orgIdentifier }}/{{ $('Generate Run ID').item.json.runId }}.html\n\nThe deal prep document can be found here:\ns3://deal-prep-artifacts/deal-prep/{{ $('Generate Run ID').item.json.orgIdentifier }}/{{ $('Generate Run ID').item.json.runId }}.html"
                            },
                            {
                                "name": "Version",
                                "value": "2010-12-01"
                            }
                        ]
                    },
                    "options": {}
                },
                "id": "email-notification-node-001",
                "name": "Send Brief Email",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4.2,
                "position": [
                    3632,
                    256
                ],
                "credentials": {
                    "aws": {
                        "id": "cDZfZsEP8rjU0RBZ",
                        "name": "AWS (IAM) account"
                    }
                },
                "continueOnFail": true
            }
        ],
        "connections": {
            "Webhook Trigger (Inbound)": {
                "main": [
                    [
                        {
                            "node": "Merge Trigger Inputs",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Manual Trigger (Outbound)": {
                "main": [
                    [
                        {
                            "node": "Merge Trigger Inputs",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Merge Trigger Inputs": {
                "main": [
                    [
                        {
                            "node": "Normalize Input",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Normalize Input": {
                "main": [
                    [
                        {
                            "node": "Generate Run ID",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Generate Run ID": {
                "main": [
                    [
                        {
                            "node": "Check Idempotency",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Check Idempotency": {
                "main": [
                    [
                        {
                            "node": "Skip (Already Complete)",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    [
                        {
                            "node": "Initialize Run Artifact",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Initialize Run Artifact": {
                "main": [
                    [
                        {
                            "node": "Ensure Firecrawl Running",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Ensure Firecrawl Running": {
                "main": [
                    [
                        {
                            "node": "Website Scrape",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Website Scrape": {
                "main": [
                    [
                        {
                            "node": "Person Enrichment",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Person Enrichment": {
                "main": [
                    [
                        {
                            "node": "LLM Synthesis",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "LLM Synthesis": {
                "main": [
                    [
                        {
                            "node": "Log AI Ideas",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Validate Brief": {
                "main": [
                    [
                        {
                            "node": "Render Outputs",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Render Outputs": {
                "main": [
                    [
                        {
                            "node": "Generate PDF",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Execute Deliveries": {
                "main": [
                    [
                        {
                            "node": "Finalize Run",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Finalize Run": {
                "main": [
                    [
                        {
                            "node": "Log Completion",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Log AI Ideas": {
                "main": [
                    [
                        {
                            "node": "Upload AI Ideas",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Generate PDF": {
                "main": [
                    [
                        {
                            "node": "Upload Deal PDF",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Upload AI Ideas": {
                "main": [
                    [
                        {
                            "node": "Validate Brief",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Upload Deal PDF": {
                "main": [
                    [
                        {
                            "node": "Send Brief Email",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Send Brief Email": {
                "main": [
                    [
                        {
                            "node": "Execute Deliveries",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            }
        },
        "authors": "Chris Miller",
        "name": null,
        "description": null,
        "autosaved": false,
        "workflowPublishHistory": [
            {
                "createdAt": "2026-01-19T20:42:08.468Z",
                "id": 79,
                "workflowId": "qRd5vZpjuYa9oujQ",
                "versionId": "1ad8725c-fd20-482f-bc6f-f4ce7cbc60fc",
                "event": "activated",
                "userId": "ce12c374-7566-4ff4-94cd-829ad101bad3"
            }
        ]
    }
}
